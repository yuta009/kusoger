<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥³ç¥ã®é­”ç‹æ®²æ»…å…µå™¨é–‹ç™ºã‚²ãƒ¼ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-bar {
            height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #4a90e2;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 30px;
        }

        .resource {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        .resource-label {
            font-size: 12px;
            color: #aaa;
        }

        .resource-value {
            font-size: 18px;
            font-weight: bold;
            color: #4a90e2;
        }

        .completion-gauge {
            flex: 1;
            max-width: 400px;
            margin-left: auto;
        }
        .elapsed-time {
            min-width: 120px;
            text-align: center;
        }

        .gauge-label {
            text-align: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .gauge-container {
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #555;
        }

        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(107, 207, 127, 0.5);
            position: relative;
            overflow: visible;
        }

        .gauge-fill::after {
            content: '';
            position: absolute;
            right: -6px;
            top: -4px;
            width: 12px;
            height: 28px;
            background: radial-gradient(circle, rgba(255,255,255,0.9), rgba(255,255,255,0));
            filter: blur(2px);
        }

        /* é–‹ç™ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        .development-field {
            height: calc(100vh - 160px);
            background: linear-gradient(45deg, #2c3e50, #34495e);
            position: relative;
            overflow: hidden;
            border: 2px solid #4a90e2;
            margin: 0 10px;
        }

        .clicker {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: 3px solid #ffd93d;
            background: radial-gradient(circle, rgba(255, 217, 61, 0.15), rgba(255, 217, 61, 0.05));
            box-shadow: 0 0 20px rgba(255, 217, 61, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.05s ease;
        }

        .clicker:active { transform: translate(-50%, -50%) scale(0.96); }

        .core-visual {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            font-size: 48px;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.4));
            transition: all 0.3s ease;
        }

        /* é­”ç‹ã®é­‚ æ¥è¿‘æ¼”å‡º */
        .threat-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at 100% 50%, rgba(139,0,0,0.15), rgba(0,0,0,0));
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .demon-soul {
            position: absolute;
            right: -80px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 56px;
            text-shadow: 0 0 12px rgba(255,0,0,0.6);
            pointer-events: none;
            transition: transform 0.5s ease;
        }

        .module {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            border: 2px solid;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .module.human {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }

        .module.machine {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            border-color: #95a5a6;
        }

        .module.magic {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-color: #9b59b6;
        }

        .module:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .module.working {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .module-progress {
            position: absolute;
            bottom: -5px;
            left: 2px;
            right: 2px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4a90e2;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .control-panel {
            height: 80px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 2px solid #4a90e2;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
        }

        .control-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }

        .control-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .control-btn.summon {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .control-btn.machine {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .control-btn.magic {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .cost-info {
            font-size: 10px;
            color: #aaa;
            margin-top: 2px;
        }

        /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .effect {
            position: absolute;
            pointer-events: none;
            font-size: 18px;
            font-weight: bold;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .success-effect {
            color: #6bcf7f;
        }

        .failure-effect {
            color: #e74c3c;
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 5px;
            border-left: 4px solid #4a90e2;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #6bcf7f;
        }

        .notification.warning {
            border-left-color: #f39c12;
        }

        .notification.error {
            border-left-color: #e74c3c;
        }

        /* ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ */
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .game-over-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #4a90e2;
            max-width: 400px;
        }

        .game-over h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .restart-btn {
            padding: 10px 30px;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes summonEffect {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(1) rotate(360deg);
                opacity: 1;
            }
        }

        .summoning {
            animation: summonEffect 1s ease-out;
        }

        /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .tutorial-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        .tutorial-card {
            width: 90%;
            max-width: 720px;
            background: linear-gradient(135deg, #2c3e50, #1f2a36);
            border: 2px solid #4a90e2;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .tutorial-title {
            font-size: 20px;
            margin-bottom: 10px;
            color: #ffd93d;
        }
        .tutorial-step {
            margin: 8px 0;
            line-height: 1.6;
        }
        .tutorial-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
        }
        .tutorial-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
    <div class="status-bar">
        <div class="resource">
            <div class="resource-label">é­”åŠ›</div>
            <div class="resource-value" id="mana">1000</div>
        </div>
        <div class="resource">
            <div class="resource-label">æŠ€è¡“P</div>
            <div class="resource-value" id="tech">500</div>
        </div>
        <div class="resource">
            <div class="resource-label">ç´ æ</div>
            <div class="resource-value" id="materials">300</div>
        </div>
        <div class="resource">
            <div class="resource-label">äººæ</div>
            <div class="resource-value" id="personnel">0</div>
        </div>
        <div class="completion-gauge">
            <div class="gauge-label">é­”ç‹æ®²æ»…å…µå™¨ å®Œæˆåº¦: <span id="completion-percent">0</span>%</div>
            <div class="gauge-container">
                <div class="gauge-fill" id="completion-gauge"></div>
            </div>
        </div>
        <div class="elapsed-time">
            <div class="resource-label">çµŒéæ™‚é–“</div>
            <div class="resource-value" id="elapsed">00:00</div>
        </div>
    </div>

    <!-- é–‹ç™ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
    <div class="development-field" id="development-field">
        <div class="core-visual" id="core-visual">âœ¨</div>
        <div class="clicker" id="clicker">ã‚¯ãƒªãƒƒã‚¯ã§é­”åŠ›+<span id="click-gain">1</span></div>
        <div class="threat-overlay" id="threat"></div>
        <div class="demon-soul" id="demon">ğŸ‘ï¸â€ğŸ—¨ï¸</div>
    </div>

    <!-- æ“ä½œãƒ‘ãƒãƒ« -->
    <div class="control-panel">
        <button class="control-btn summon" id="summon-btn">
            ç•°ä¸–ç•Œå¬å–š
            <div class="cost-info">é­”åŠ›:100 ç´ æ:50</div>
        </button>
        <button class="control-btn summon" id="enhance-btn">
            äººé–“å¼·åŒ–
            <div class="cost-info">é­”åŠ›:80 æŠ€è¡“P:30</div>
        </button>
        <button class="control-btn machine" id="machine-btn">
            æ©Ÿæ¢°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
            <div class="cost-info">æŠ€è¡“P:100 ç´ æ:80</div>
        </button>
        <button class="control-btn magic" id="magic-btn">
            é­”æ³•ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
            <div class="cost-info">é­”åŠ›:150 æŠ€è¡“P:50</div>
        </button>
        <button class="control-btn" id="invest-btn">
            è³‡æºæŠ•å…¥
            <div class="cost-info">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚‚å¯</div>
        </button>
        <button class="control-btn" id="auto-btn">
            è‡ªå‹•é–‹ç™º
            <div class="cost-info">æ•°å­—ã‚­ãƒ¼1-3ã§åŠ¹æœ</div>
        </button>
        <button class="control-btn" id="invest-human">
            æŠ•è³‡:äººé–“ Lv.<span id="lv-human">0</span>
            <div class="cost-info" id="cost-human">é­”åŠ›:100</div>
        </button>
        <button class="control-btn" id="invest-machine">
            æŠ•è³‡:æ©Ÿæ¢° Lv.<span id="lv-machine">0</span>
            <div class="cost-info" id="cost-machine">æŠ€è¡“P:80 ç´ æ:60</div>
        </button>
        <button class="control-btn" id="invest-magic">
            æŠ•è³‡:é­”æ³• Lv.<span id="lv-magic">0</span>
            <div class="cost-info" id="cost-magic">é­”åŠ›:120 æŠ€è¡“P:40</div>
        </button>
    </div>

    <!-- é€šçŸ¥ -->
    <div class="notification" id="notification"></div>

    <!-- ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ -->
    <div class="game-over" id="game-over">
        <div class="game-over-content">
            <h2 id="game-over-title">é–‹ç™ºå®Œäº†ï¼</h2>
            <p id="game-over-message">é­”ç‹æ®²æ»…å…µå™¨ã®é–‹ç™ºã«æˆåŠŸã—ã¾ã—ãŸï¼</p>
            <button class="restart-btn" onclick="restartGame()">å†é–‹ç™º</button>
        </div>
    </div>

    <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="tutorial-overlay" id="tutorial">
        <div class="tutorial-card">
            <div class="tutorial-title">å¥³ç¥ã®å…µå™¨é–‹ç™º ã¸ã‚ˆã†ã“ã</div>
            <div class="tutorial-step">1) ç”»é¢ä¸­å¤®ã®å††ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é­”åŠ›ã‚’ç²å¾—ã—ã¾ã™</div>
            <div class="tutorial-step">2) ä¸‹éƒ¨ã®ãƒœã‚¿ãƒ³ã§æŠ•è³‡/å¬å–š/å¼·åŒ–/æ©Ÿæ¢°/é­”æ³•ã‚’å®Ÿè¡Œ</div>
            <div class="tutorial-step">3) ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§é­”åŠ›20ã‚’æŠ€è¡“Pã‹ç´ æã«ãƒ©ãƒ³ãƒ€ãƒ è»¢ç”¨</div>
            <div class="tutorial-step">4) è‡ªå‹•é–‹ç™ºã¯ã‚¯ãƒªãƒƒã‚¯ã®è‡ªå‹•ä»£è¡Œã®ã¿ã€‚åˆ¶é™æ™‚é–“ã¯3åˆ†</div>
            <div class="tutorial-actions">
                <button class="tutorial-btn" id="tutorial-close">é–‹å§‹ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="tutorial-overlay" id="story-overlay">
        <div class="tutorial-card">
            <div class="tutorial-title" id="story-title">ç‰©èª</div>
            <div id="story-content" style="line-height:1.7; white-space:pre-line"></div>
            <div class="tutorial-actions">
                <button class="tutorial-btn" id="story-next">ç¶šã‘ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            mana: 1000,
            tech: 500,
            materials: 300,
            personnel: 0,
            completion: 0,
            modules: [],
            nextModuleId: 1,
            gameRunning: true,
            autoMode: false,
            storyIndex: 0,
            startedAt: Date.now(),
            secondsElapsed: 0,
            choices: { summon: 0, enhance: 0, machine: 0, magic: 0, invest: 0 },
            clickGainBase: 1,
            investLevels: { human: 0, machine: 0, magic: 0 }
        };

        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—
        const MODULE_TYPES = {
            HUMAN: 'human',
            MACHINE: 'machine',
            MAGIC: 'magic'
        };

        // ã‚³ã‚¹ãƒˆè¨­å®š
        const COSTS = {
            summon: { mana: 100, materials: 50 },
            enhance: { mana: 80, tech: 30 },
            machine: { tech: 100, materials: 80 },
            magic: { mana: 150, tech: 50 }
        };

        // DOMè¦ç´ 
        const elements = {
            mana: document.getElementById('mana'),
            tech: document.getElementById('tech'),
            materials: document.getElementById('materials'),
            personnel: document.getElementById('personnel'),
            completion: document.getElementById('completion-percent'),
            gauge: document.getElementById('completion-gauge'),
            field: document.getElementById('development-field'),
            notification: document.getElementById('notification'),
            gameOver: document.getElementById('game-over'),
            gameOverTitle: document.getElementById('game-over-title'),
            gameOverMessage: document.getElementById('game-over-message'),
            storyOverlay: document.getElementById('story-overlay'),
            storyTitle: document.getElementById('story-title'),
            storyContent: document.getElementById('story-content'),
            clicker: document.getElementById('clicker'),
            clickGain: document.getElementById('click-gain'),
            coreVisual: document.getElementById('core-visual'),
            lvHuman: document.getElementById('lv-human'),
            lvMachine: document.getElementById('lv-machine'),
            lvMagic: document.getElementById('lv-magic'),
            costHuman: document.getElementById('cost-human'),
            costMachine: document.getElementById('cost-machine'),
            costMagic: document.getElementById('cost-magic'),
            threat: document.getElementById('threat'),
            demon: document.getElementById('demon')
        };
        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆä»•æ§˜æ›¸ã‚ˆã‚Šè¦ç´„ï¼‰
        const STORY = [
            {
                title: 'åºç« ï¼šå¥³ç¥ã®æ±ºæ„',
                text: 'å‰ä½œã§ã€é­”ç‹ã®æ™‚ç©ºå¹²æ¸‰ã«ã‚ˆã‚Šå‹‡è€…ã®è»¢ç”ŸãŒé˜»æ­¢ã•ã‚ŒãŸã€‚\nå¥³ç¥ã¯é­”ç‹æ®²æ»…å…µå™¨ã®é–‹ç™ºã«ä¹—ã‚Šå‡ºã™ã€‚'
            },
            {
                title: 'ç ”ç©¶é–‹å§‹',
                text: 'å…µå™¨ã®å®Œæˆã«ã¯ã€äººæãƒ»æ©Ÿæ¢°ãƒ»é­”æ³•ã€ãã—ã¦è†¨å¤§ãªè³‡æºãŒå¿…è¦ã ã€‚\nã¾ãšã¯äººæã‚’ç¢ºä¿ã—ã‚ˆã†ï¼ˆç•°ä¸–ç•Œå¬å–šï¼‰ã€‚'
            },
            {
                title: 'æŠ€è¡“é©æ–°ã®å…†ã—',
                text: 'æ©Ÿæ¢°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨é­”æ³•ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç›¸äº’ä½œç”¨ã§ã€äºˆæƒ³å¤–ã®é€²å±•ãŒèµ·ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚'
            },
            {
                title: 'ç„¦ã‚Šã¨ç¥ˆã‚Š',
                text: 'è³‡æºãŒå³ã—ã„ã€‚ã ãŒè«¦ã‚ã‚‰ã‚Œãªã„â€”â€”ã“ã®ä¸–ç•Œã®æœªæ¥ã®ãŸã‚ã«ã€‚'
            },
            {
                title: 'å®Œæˆã¸',
                text: 'å®Œæˆåº¦ãŒé«˜ã¾ã£ã¦ããŸã€‚æœ€å¾Œã®ä»•ä¸Šã’ã«å…¨åŠ›ã‚’æ³¨ã”ã†ã€‚'
            }
        ];

        function showStory(index) {
            if (!STORY[index]) return;
            gameState.storyIndex = index;
            elements.storyTitle.textContent = STORY[index].title;
            elements.storyContent.textContent = STORY[index].text;
            elements.storyOverlay.style.display = 'flex';
        }

        function hideStory() {
            elements.storyOverlay.style.display = 'none';
        }


        // åˆæœŸåŒ–
        function init() {
            updateDisplay();
            setupEventListeners();
            startGameLoop();
            // åˆå›ã®ã¿ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«è¡¨ç¤ºï¼ˆç°¡ç•¥åŒ–: æ¯å›è¡¨ç¤ºï¼‰
            const tutorial = document.getElementById('tutorial');
            if (tutorial) {
                tutorial.style.display = 'flex';
            }
            // å°å…¥ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’è¡¨ç¤º
            showStory(0);
            updateInvestUI();
            updateCoreVisual();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            document.getElementById('summon-btn').addEventListener('click', () => summonHuman());
            document.getElementById('enhance-btn').addEventListener('click', () => enhanceHuman());
            document.getElementById('machine-btn').addEventListener('click', () => createMachine());
            document.getElementById('magic-btn').addEventListener('click', () => createMagic());
            document.getElementById('invest-btn').addEventListener('click', () => investResources());
            document.getElementById('auto-btn').addEventListener('click', () => toggleAuto());

            // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é–‰ã˜ã‚‹
            const closeBtn = document.getElementById('tutorial-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    const tutorial = document.getElementById('tutorial');
                    if (tutorial) tutorial.style.display = 'none';
                });
            }

            const storyNext = document.getElementById('story-next');
            if (storyNext) {
                storyNext.addEventListener('click', () => hideStory());
            }

            if (elements.clicker) {
                elements.clicker.addEventListener('click', () => {
                    const gain = getClickGain();
                    gameState.mana += gain;
                    elements.clickGain.textContent = gain;
                    showEffect(elements.field.offsetWidth/2, elements.field.offsetHeight/2, `+${gain}é­”åŠ›`);
                    updateDisplay();
                });
            }

            const investHumanBtn = document.getElementById('invest-human');
            const investMachineBtn = document.getElementById('invest-machine');
            const investMagicBtn = document.getElementById('invest-magic');
            investHumanBtn?.addEventListener('click', () => invest('human'));
            investMachineBtn?.addEventListener('click', () => invest('machine'));
            investMagicBtn?.addEventListener('click', () => invest('magic'));

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã®ã¿ï¼‰
            document.addEventListener('keydown', (e) => {
                if (!gameState.gameRunning) return;
                if (e.key === ' ') {
                    e.preventDefault();
                    investResources();
                }
            });
        }

        // ç•°ä¸–ç•Œäººé–“å¬å–š
        function summonHuman() {
            gameState.choices.summon++;
            if (!canAfford(COSTS.summon)) {
                showNotification('è³‡æºãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                return;
            }

            spendResources(COSTS.summon);
            
            const successRate = Math.min(0.9, 0.5 + (gameState.personnel * 0.1));
            if (Math.random() < successRate) {
                gameState.personnel++;
                createModule(MODULE_TYPES.HUMAN, getRandomPosition());
                showNotification('ç•°ä¸–ç•Œäººé–“å¬å–šæˆåŠŸï¼', 'success');
                addProgress(3);
            } else {
                showNotification('å¬å–šã«å¤±æ•—ã—ã¾ã—ãŸ...', 'error');
            }
            
            updateDisplay();
        }

        // æ—¢å­˜äººé–“å¼·åŒ–
        function enhanceHuman() {
            gameState.choices.enhance++;
            if (gameState.personnel === 0) {
                showNotification('å¼·åŒ–ã™ã‚‹äººæãŒã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            if (!canAfford(COSTS.enhance)) {
                showNotification('è³‡æºãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                return;
            }

            spendResources(COSTS.enhance);
            
            if (Math.random() < 0.8) {
                const humanModules = gameState.modules.filter(m => m.type === MODULE_TYPES.HUMAN);
                if (humanModules.length > 0) {
                    const module = humanModules[Math.floor(Math.random() * humanModules.length)];
                    module.level = (module.level || 1) + 1;
                    updateModuleDisplay(module);
                    showNotification('äººé–“å¼·åŒ–æˆåŠŸï¼', 'success');
                    addProgress(4);
                }
            } else {
                gameState.personnel = Math.max(0, gameState.personnel - 1);
                showNotification('å¼·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ...', 'error');
            }
            
            updateDisplay();
        }

        // æ©Ÿæ¢°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
        function createMachine() {
            gameState.choices.machine++;
            if (!canAfford(COSTS.machine)) {
                showNotification('è³‡æºãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                return;
            }

            spendResources(COSTS.machine);
            createModule(MODULE_TYPES.MACHINE, getRandomPosition());
            showNotification('æ©Ÿæ¢°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–‹ç™ºå®Œäº†ï¼', 'success');
            addProgress(3);
            updateDisplay();
        }

        // é­”æ³•ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
        function createMagic() {
            gameState.choices.magic++;
            if (!canAfford(COSTS.magic)) {
                showNotification('è³‡æºãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                return;
            }

            spendResources(COSTS.magic);
            createModule(MODULE_TYPES.MAGIC, getRandomPosition());
            showNotification('é­”æ³•ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–‹ç™ºå®Œäº†ï¼', 'success');
            addProgress(4);
            updateDisplay();
        }

        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
        function createModule(type, position) {
            const module = {
                id: gameState.nextModuleId++,
                type: type,
                x: position.x,
                y: position.y,
                level: initialLevelForType(type),
                progress: 0,
                working: false
            };

            gameState.modules.push(module);
            
            const element = document.createElement('div');
            element.className = `module ${type} summoning`;
            element.id = `module-${module.id}`;
            element.style.left = `${position.x}px`;
            element.style.top = `${position.y}px`;
            
            const progressBar = document.createElement('div');
            progressBar.className = 'module-progress';
            const progressFill = document.createElement('div');
            progressFill.className = 'progress-fill';
            progressBar.appendChild(progressFill);
            element.appendChild(progressBar);
            
            updateModuleContent(element, module);
            elements.field.appendChild(element);

            // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
            makeModuleDraggable(element, module);
        }

        // æŠ•è³‡ã¨é€£å‹•ã—ãŸåˆæœŸãƒ¬ãƒ™ãƒ«æ±ºå®š
        function initialLevelForType(type) {
            if (type === MODULE_TYPES.HUMAN) return Math.max(1, gameState.investLevels.human);
            if (type === MODULE_TYPES.MACHINE) return Math.max(1, gameState.investLevels.machine);
            if (type === MODULE_TYPES.MAGIC) return Math.max(1, gameState.investLevels.magic);
            return 1;
        }

        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…å®¹æ›´æ–°
        function updateModuleContent(element, module) {
            const typeNames = {
                [MODULE_TYPES.HUMAN]: 'äººé–“',
                [MODULE_TYPES.MACHINE]: 'æ©Ÿæ¢°',
                [MODULE_TYPES.MAGIC]: 'é­”æ³•'
            };
            
            element.innerHTML = `
                <div>${typeNames[module.type]}</div>
                <div>Lv.${module.level}</div>
                <div class="module-progress">
                    <div class="progress-fill" style="width: ${module.progress}%"></div>
                </div>
            `;
        }

        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºæ›´æ–°
        function updateModuleDisplay(module) {
            const element = document.getElementById(`module-${module.id}`);
            if (element) {
                updateModuleContent(element, module);
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
        function makeModuleDraggable(element, module) {
            let isDragging = false;
            let startX, startY;

            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX - element.offsetLeft;
                startY = e.clientY - element.offsetTop;
                element.style.zIndex = '1000';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const rect = elements.field.getBoundingClientRect();
                let newX = e.clientX - startX - rect.left;
                let newY = e.clientY - startY - rect.top;
                
                // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
                newX = Math.max(0, Math.min(newX, elements.field.offsetWidth - 80));
                newY = Math.max(0, Math.min(newY, elements.field.offsetHeight - 80));
                
                element.style.left = `${newX}px`;
                element.style.top = `${newY}px`;
                
                module.x = newX;
                module.y = newY;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.zIndex = '';
                }
            });
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®å–å¾—
        function getRandomPosition() {
            const fieldRect = elements.field.getBoundingClientRect();
            return {
                x: Math.random() * (fieldRect.width - 80),
                y: Math.random() * (fieldRect.height - 80)
            };
        }

        // è³‡æºæŠ•å…¥ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ï¼‰ï¼šé­”åŠ›20ã‚’æŠ€è¡“Pã¾ãŸã¯ç´ æã¸ãƒ©ãƒ³ãƒ€ãƒ åˆ†é…
        function investResources() {
            gameState.choices.invest++;
            const spend = Math.min(20, gameState.mana);
            if (spend === 0) {
                showNotification('é­”åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                return;
            }
            gameState.mana -= spend;
            if (Math.random() < 0.5) {
                gameState.tech += spend;
                showNotification(`é­”åŠ›${spend}ã‚’æŠ€è¡“Pã«è»¢ç”¨`, 'success');
            } else {
                gameState.materials += spend;
                showNotification(`é­”åŠ›${spend}ã‚’ç´ æã«è»¢ç”¨`, 'success');
            }
            updateDisplay();
        }

        // é€²æ—è¿½åŠ 
        function addProgress(amount) {
            const inc = Math.max(0, Math.floor(amount));
            gameState.completion = Math.min(100, gameState.completion + inc);
            // é€²æ—æ¼”å‡ºï¼ˆæ•´æ•°è¡¨ç¤ºï¼‰
            const cx = elements.field.offsetWidth / 2;
            const cy = elements.field.offsetHeight / 2;
            if (inc > 0) showEffect(cx, cy, `+${inc}%`, 'success');
            
            // ç‰©èªé€²è¡Œã®ç°¡æ˜“ãƒˆãƒªã‚¬ï¼ˆ25/50/75/100%ï¼‰
            if (gameState.completion >= 25 && gameState.storyIndex < 1) showStory(1);
            if (gameState.completion >= 50 && gameState.storyIndex < 2) showStory(2);
            if (gameState.completion >= 75 && gameState.storyIndex < 3) showStory(3);

            if (gameState.completion >= 100 && gameState.gameRunning) {
                endGame(true);
            }
        }

        // è‡ªå‹•é–‹ç™ºåˆ‡æ›¿
        function toggleAuto() {
            gameState.autoMode = !gameState.autoMode;
            const btn = document.getElementById('auto-btn');
            btn.textContent = gameState.autoMode ? 'è‡ªå‹•åœæ­¢' : 'è‡ªå‹•é–‹ç™º';
            btn.style.background = gameState.autoMode ? 
                'linear-gradient(135deg, #e74c3c, #c0392b)' : 
                'linear-gradient(135deg, #4a90e2, #357abd)';
            
            showNotification(gameState.autoMode ? 'è‡ªå‹•é–‹ç™ºé–‹å§‹' : 'è‡ªå‹•é–‹ç™ºåœæ­¢', 'success');
        }

        // ç‰¹æ®ŠåŠ¹æœ
        function accelerateProgress() {
            if (gameState.mana >= 50) {
                gameState.mana -= 50;
                addProgress(30);
                showNotification('é–‹ç™ºåŠ é€Ÿï¼', 'success');
                updateDisplay();
            }
        }

        function increaseSuccessRate() {
            if (gameState.tech >= 30) {
                gameState.tech -= 30;
                // æ¬¡å›ã®æˆåŠŸç‡ã‚’å‘ä¸Šï¼ˆå®Ÿè£…ç°¡ç•¥åŒ–ã®ãŸã‚å³åº§ã«é€²æ—è¿½åŠ ï¼‰
                addProgress(20);
                showNotification('æˆåŠŸç‡ä¸Šæ˜‡ï¼', 'success');
                updateDisplay();
            }
        }

        function saveMaterials() {
            if (gameState.completion > 10) {
                gameState.materials += 20;
                gameState.completion -= 5;
                showNotification('ç´ æç¯€ç´„ãƒ¢ãƒ¼ãƒ‰', 'success');
                updateDisplay();
            }
        }

        // è³‡æºãƒã‚§ãƒƒã‚¯
        function canAfford(cost) {
            return (cost.mana || 0) <= gameState.mana &&
                   (cost.tech || 0) <= gameState.tech &&
                   (cost.materials || 0) <= gameState.materials;
        }

        // è³‡æºæ¶ˆè²»
        function spendResources(cost) {
            gameState.mana -= cost.mana || 0;
            gameState.tech -= cost.tech || 0;
            gameState.materials -= cost.materials || 0;
        }

        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            // æ•´æ•°è¡¨ç¤ºã«çµ±ä¸€
            gameState.mana = Math.floor(gameState.mana);
            gameState.tech = Math.floor(gameState.tech);
            gameState.materials = Math.floor(gameState.materials);
            elements.mana.textContent = Math.floor(gameState.mana);
            elements.tech.textContent = Math.floor(gameState.tech);
            elements.materials.textContent = Math.floor(gameState.materials);
            elements.personnel.textContent = gameState.personnel;
            elements.completion.textContent = Math.floor(gameState.completion);
            elements.gauge.style.width = `${gameState.completion}%`;
            const seconds = Math.max(0, Number(gameState.secondsElapsed) || 0);
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            const elapsed = document.getElementById('elapsed');
            if (elapsed) elapsed.textContent = `${m}:${s}`;

            // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            updateButtonStates();
            updateInvestUI();
        }

        // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        function updateButtonStates() {
            document.getElementById('summon-btn').disabled = !canAfford(COSTS.summon);
            document.getElementById('enhance-btn').disabled = !canAfford(COSTS.enhance) || gameState.personnel === 0;
            document.getElementById('machine-btn').disabled = !canAfford(COSTS.machine);
            document.getElementById('magic-btn').disabled = !canAfford(COSTS.magic);
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, type = 'info') {
            elements.notification.textContent = message;
            elements.notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }

        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
        function showEffect(x, y, text, type = 'success') {
            const effect = document.createElement('div');
            effect.className = `effect ${type}-effect`;
            effect.textContent = text;
            effect.style.left = `${x}px`;
            effect.style.top = `${y}px`;
            
            elements.field.appendChild(effect);
            
            setTimeout(() => {
                elements.field.removeChild(effect);
            }, 1000);
        }

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function startGameLoop() {
            setInterval(() => {
                if (!gameState.gameRunning) return;

                // è³‡æºå›å¾©
                gameState.mana += 3;      // èª¿æ•´ï¼šé…ã
                gameState.tech += 1;      // èª¿æ•´ï¼šé…ã
                gameState.materials += 1; // æ®ãˆç½®ã
                gameState.secondsElapsed++;

                // æŠ•è³‡åŠ¹æœï¼šãƒ‘ãƒƒã‚·ãƒ–åå…¥
                const l = gameState.investLevels;
                gameState.mana += l.human * 0.5 + l.magic * 0.3;
                gameState.tech += l.machine * 0.5 + l.magic * 0.2;
                gameState.materials += l.machine * 0.4;

                // è‡ªå‹•é–‹ç™ºï¼šã‚¯ãƒªãƒƒã‚¯ä»£è¡Œã®ã¿
                if (gameState.autoMode && Math.random() < 0.6) {
                    const gain = getClickGain();
                    gameState.mana += gain;
                }

                // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæ¥­é€²è¡Œ
                gameState.modules.forEach(module => {
                    if (Math.random() < 0.15) { // ä½œæ¥­é »åº¦ã‚’ä½ä¸‹
                        module.progress = Math.min(100, module.progress + 8); // é€²æ—é‡ã‚’ä½ä¸‹
                        const element = document.getElementById(`module-${module.id}`);
                        if (element) {
                            element.classList.add('working');
                            setTimeout(() => element.classList.remove('working'), 500);
                        }
                        
                        if (module.progress >= 100) {
                            module.progress = 0;
                            addProgress(4 * module.level); // å®Œæˆåº¦ä¸Šæ˜‡ã‚’èª¿æ•´
                            showEffect(module.x + 40, module.y + 40, `+${5 * module.level}%`);
                        }
                        updateModuleDisplay(module);
                    }
                });

                // ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
                if (Math.random() < 0.05) {
                    triggerRandomEvent();
                }

                // å¤±æ•—æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                if (gameState.mana <= 0 && gameState.tech <= 0 && gameState.materials <= 0) {
                    endGame(false);
                }

                updateDisplay();
                updateCoreVisual();
                checkTimeLimit();
            }, 1000);
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
        function triggerRandomEvent() {
            const events = [
                {
                    name: 'é­”åŠ›çµæ™¶ç™ºè¦‹',
                    effect: () => {
                        gameState.mana += 100;
                        showNotification('é­”åŠ›çµæ™¶ã‚’ç™ºè¦‹ï¼é­”åŠ›+100', 'success');
                    }
                },
                {
                    name: 'æŠ€è¡“é©æ–°',
                    effect: () => {
                        gameState.tech += 80;
                        showNotification('æŠ€è¡“çš„ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¹ãƒ«ãƒ¼ï¼æŠ€è¡“P+80', 'success');
                    }
                },
                {
                    name: 'ç´ æä¸è¶³',
                    effect: () => {
                        gameState.materials = Math.max(0, gameState.materials - 30);
                        showNotification('ç´ æãŒåŠ£åŒ–ã—ã¾ã—ãŸ...ç´ æ-30', 'warning');
                    }
                },
                {
                    name: 'å¶ç„¶ã®ç™ºè¦‹',
                    effect: () => {
                        // é€²æ—ã¯åŠ ç®—ã—ãªã„ã€‚ä»£ã‚ã‚Šã«è³‡æºãƒœãƒ¼ãƒŠã‚¹ã®ã¿ä»˜ä¸
                        gameState.mana += 30;
                        gameState.tech += 15;
                        showNotification('å¶ç„¶ã®ç™ºè¦‹ï¼é­”åŠ›+30 æŠ€è¡“P+15', 'success');
                    }
                }
            ];

            const event = events[Math.floor(Math.random() * events.length)];
            event.effect();
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†
        function endGame(success) {
            gameState.gameRunning = false;
            
            if (success) {
                elements.gameOverTitle.textContent = 'é–‹ç™ºå®Œäº†ï¼';
                const ending = determineEnding();
                elements.gameOverMessage.textContent = `${ending.name} ãŒå®Œæˆï¼\n${ending.story}`;
            } else {
                elements.gameOverTitle.textContent = 'é–‹ç™ºå¤±æ•—...';
                elements.gameOverMessage.textContent = 'è³‡æºãŒæ¯æ¸‡ã—ã€é–‹ç™ºã‚’ç¶šè¡Œã§ãã¾ã›ã‚“ã€‚é­”ç‹ã®è„…å¨ã¯ç¶šãã¾ã™...';
            }
            
            elements.gameOver.style.display = 'flex';
        }

        // 10åˆ†çµŒéã§ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼
        function checkTimeLimit() {
            // æ™‚é–“åˆ¶é™ï¼š5åˆ†=300ç§’
            const limit = 180;
            if (gameState.secondsElapsed >= limit && gameState.gameRunning) {
                elements.gameOverTitle.textContent = 'ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼';
                elements.gameOverMessage.textContent = 'é­”ç‹ã«æ°—é…ã‚’å¯ŸçŸ¥ã•ã‚Œã€ç ”ç©¶æ–½è¨­ãŒéœ²è¦‹ã—ãŸâ€¦â€¦ã€‚å¥³ç¥ã®å…µå™¨é–‹ç™ºã¯æœªå®Œæˆã®ã¾ã¾å¤±æ•—ã«çµ‚ã‚ã£ãŸã€‚æ¬¡ã®æ™‚é–“ç·šã§ã€ã‚ˆã‚Šè¿…é€Ÿã«é–‹ç™ºã‚’é€²ã‚ã‚ˆã†ã€‚';
                elements.gameOver.style.display = 'flex';
                gameState.gameRunning = false;
            }
            // æ®‹ã‚Šæ™‚é–“ã«å¿œã˜ãŸè„…å¨æ¼”å‡º
            const remain = Math.max(0, limit - gameState.secondsElapsed);
            const t = 1 - (remain / limit); // 0â†’1
            if (elements.threat) elements.threat.style.opacity = (t * 0.9).toFixed(2);
            if (elements.demon) {
                const shift = Math.floor(200 - 200 * t); // 200pxâ†’0px
                elements.demon.style.transform = `translateY(-50%) translateX(-${shift}px)`;
            }
        }

        // åˆ†å²ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°åˆ¤å®š
        function determineEnding() {
            // æŠ•è³‡ãƒ¬ãƒ™ãƒ«æ¯”ç‡ã‹ã‚‰ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ±ºå®š
            const l = gameState.investLevels;
            const H = l.human;
            const M = l.machine;
            const G = l.magic;
            const total = H + M + G;

            // ã‚»ãƒ¼ãƒ•ã‚¬ãƒ¼ãƒ‰ï¼šæŠ•è³‡ãŒå…¨ãç„¡ã„å ´åˆã¯äººæå¯„ã‚Šã®åŸºæœ¬å…µå™¨
            if (total === 0) {
                return { name: 'è–éºãƒ»è‹±é›„å¢—å¹…ç ²', story: 'æ•°å¤šã®äººæãŒåŠ›ã‚’åˆã‚ã›ã€è‹±é›„ã®æ„å¿—ã‚’çµæ™¶åŒ–ã€‚é­”ç‹ã®ç²¾ç¥ã‚’å´©ã—å»ã‚‹è–ãªã‚‹æ³¢å‹•ã‚’æ”¾ã¤ã€‚' };
            }

            const hR = H / total, mR = M / total, gR = G / total;

            // æ¥µç‰¹åŒ–ï¼ˆå˜è‰²ãŒ70%ä»¥ä¸Šï¼‰
            if (gR >= 0.7) {
                return { name: 'æ™‚ç©ºæ»…ç•Œãƒ»ã‚¢ãƒã‚«ãƒªãƒ—ã‚¹æ ¸', story: 'é­”æ³•ç†è«–ã®æ¥µç‚¹ã«åˆ°é”ã—ãŸé­”å°æ ¸ã€‚æ™‚é–“ãã®ã‚‚ã®ã‚’æ›¸ãæ›ãˆã€é­”ç‹ã®å­˜åœ¨åŸç†ã‚’å‰Šé™¤ã™ã‚‹ã€‚' };
            }
            if (mR >= 0.7) {
                return { name: 'è¶…æ¼”ç®—æ®²æ»…æ©Ÿãƒ»Î©ãƒ¬ã‚®ã‚ªãƒ³', story: 'æ©Ÿæ¢°ç¾¤ãŒä¸€å€‹æƒ‘æ˜Ÿç´šã®æ¼”ç®—ã‚’å±•é–‹ã€‚é­”ç‹ã®è¡Œå‹•ã‚’å…ˆèª­ã¿ã—ã€ç¢ºå®šç ´å£Šã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã€‚' };
            }
            if (hR >= 0.7) {
                return { name: 'è–åŸŸåˆå”±ç ²ãƒ»ãƒ«ã‚¯ã‚¹ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«', story: 'è¦šé†’ã—ãŸäººæã®é­‚ã‚’åŒèª¿ã•ã›ã€ç´”å…‰ã®åˆå”±ã‚’ç ²æ’ƒã¸è»¢æ›ã€‚é­”ç‹ã®é—‡ã‚’æ­Œã§æ‰“ã¡æ¶ˆã™ã€‚' };
            }

            // äºŒè‰²ã‚·ãƒŠã‚¸ãƒ¼ï¼ˆ2ã¤ãŒå„40%ä»¥ä¸Šï¼‰
            if (hR >= 0.4 && gR >= 0.4) {
                return { name: 'è–é­”åˆä¸€ãƒ»ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒãƒ³', story: 'äººã®æ„å¿—ã¨é­”ã®ç†ãŒèåˆã€‚äºˆè¨€çš„åæŸç ²ãŒé­”ç‹ã®æœªæ¥ã‚’ä¸€æ¡ã«è²«ãã€‚' };
            }
            if (hR >= 0.4 && mR >= 0.4) {
                return { name: 'ç¾©ä½“é€£æºãƒ»è‹±å‚‘æ©Ÿå…µå›£', story: 'é›ãˆæŠœã‹ã‚ŒãŸäººæã¨æ©Ÿæ¢°ã®èº¯ãŒåŒèª¿ã€‚æˆ¦è¡“é€£æºãŒæ¥µé™ã«é”ã—ã€æ®²æ»…ã®æ—‹å¾‹ã‚’å¥ã§ã‚‹ã€‚' };
            }
            if (mR >= 0.4 && gR >= 0.4) {
                return { name: 'é­”å°æ©Ÿæ§‹ãƒ»ã‚¢ãƒ¼ã‚±ã‚¤ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³', story: 'é­”åŠ›ã‚’å·¥å­¦ã§åˆ¶å¾¡ã™ã‚‹å·¨å¤§æ©Ÿé–¢ã€‚é­”ç‹ã®å‘ªè©›ã‚’ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¸è»¢æ›ã—ã€åæ’ƒã®ç‚ã«å¤‰ãˆã‚‹ã€‚' };
            }

            // ä¸‰è‰²ãƒãƒ©ãƒ³ã‚¹ï¼ˆå„30%ä»¥ä¸Šï¼‰
            if (hR >= 0.3 && mR >= 0.3 && gR >= 0.3) {
                return { name: 'çµ±åˆå…µè£…ãƒ»å‰µä¸–ã‚¢ãƒ¼ã‚¯', story: 'äººãƒ»æ©Ÿæ¢°ãƒ»é­”æ³•ãŒç­‰ã—ãè¼ãç©¶æ¥µå…µè£…ã€‚ã‚ã‚‰ã‚†ã‚‹æ™‚é–“ç·šã§å‹åˆ©ã‚’ç´„æŸã™ã‚‹ã€‚' };
            }

            // ãã‚Œä»¥å¤–ï¼šæœ€ã‚‚é«˜ã„ç³»çµ±ã«å¿œã˜ãŸå˜è‰²å¼·åŒ–ç‰ˆ
            if (gR >= mR && gR >= hR) {
                return { name: 'ç¥è¨—ãƒ»æ™‚ç©ºé€£çµé­”å°æ ¸', story: 'æ™‚ç©ºã‚’æŸã­ã‚‹é­”å°æ ¸ã€‚å¥³ç¥ã®ç¥ˆã‚Šã¨å…±é³´ã—ã€é­”ç‹ã®æ™‚é–“ç·šãã®ã‚‚ã®ã‚’æ›¸ãæ›ãˆã‚‹ã€‚' };
            }
            if (mR >= hR) {
                return { name: 'æ©Ÿç¥ãƒ»çµ‚æœ«æ¼”ç®—è¦å¡', story: 'æ©Ÿæ¢°ã®å¡æ™ºãŒæ¥µã¾ã£ãŸå·¨å¤§è¦å¡ã€‚ç„¡å°½ã®æ¼”ç®—ã§é­”ç‹ã®è¡Œå‹•ã‚’å…ˆèª­ã¿ã—ã€è‡´å‘½ã®ä¸€æ’ƒã‚’å©ãè¾¼ã‚€ã€‚' };
            }
            return { name: 'è–éºãƒ»è‹±é›„å¢—å¹…ç ²', story: 'æ•°å¤šã®äººæãŒåŠ›ã‚’åˆã‚ã›ã€è‹±é›„ã®æ„å¿—ã‚’çµæ™¶åŒ–ã€‚é­”ç‹ã®ç²¾ç¥ã‚’å´©ã—å»ã‚‹è–ãªã‚‹æ³¢å‹•ã‚’æ”¾ã¤ã€‚' };
        }

        // ã‚¯ãƒªãƒƒã‚¯åå…¥ã®ç®—å‡ºï¼ˆæŠ•è³‡ãƒ¬ãƒ™ãƒ«ã§å¢—åŠ ï¼‰
        function getClickGain() {
            const l = gameState.investLevels;
            return Math.floor(gameState.clickGainBase + l.human * 1 + l.machine * 0.5 + l.magic * 0.8);
        }

        // æŠ•è³‡ã‚³ã‚¹ãƒˆã¨UIæ›´æ–°
        function updateInvestUI() {
            const l = gameState.investLevels;
            elements.lvHuman.textContent = l.human;
            elements.lvMachine.textContent = l.machine;
            elements.lvMagic.textContent = l.magic;
            elements.costHuman.textContent = `é­”åŠ›:${100 + l.human * 60}`;
            elements.costMachine.textContent = `æŠ€è¡“P:${80 + l.machine * 50} ç´ æ:${60 + l.machine * 40}`;
            elements.costMagic.textContent = `é­”åŠ›:${120 + l.magic * 70} æŠ€è¡“P:${40 + l.magic * 40}`;
            elements.clickGain.textContent = getClickGain();
        }

        // æŠ•è³‡å‡¦ç†ã¨åŠ¹æœ
        function invest(kind) {
            const l = gameState.investLevels;
            if (kind === 'human') {
                const cost = 100 + l.human * 60;
                if (gameState.mana < cost) return showNotification('é­”åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                gameState.mana -= cost;
                l.human++;
                addProgress(2);
                // æ—¢å­˜ã®äººé–“ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚‚åæ˜ 
                gameState.modules.filter(m => m.type === MODULE_TYPES.HUMAN).forEach(m => { m.level = Math.max(m.level, l.human); updateModuleDisplay(m); });
            } else if (kind === 'machine') {
                const costT = 80 + l.machine * 50;
                const costM = 60 + l.machine * 40;
                if (gameState.tech < costT || gameState.materials < costM) return showNotification('è³‡æºãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                gameState.tech -= costT;
                gameState.materials -= costM;
                l.machine++;
                addProgress(2.5);
                // æ—¢å­˜ã®æ©Ÿæ¢°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚‚åæ˜ 
                gameState.modules.filter(m => m.type === MODULE_TYPES.MACHINE).forEach(m => { m.level = Math.max(m.level, l.machine); updateModuleDisplay(m); });
            } else if (kind === 'magic') {
                const costMana = 120 + l.magic * 70;
                const costTech = 40 + l.magic * 40;
                if (gameState.mana < costMana || gameState.tech < costTech) return showNotification('è³‡æºãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                gameState.mana -= costMana;
                gameState.tech -= costTech;
                l.magic++;
                addProgress(3);
                // æ—¢å­˜ã®é­”æ³•ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚‚åæ˜ 
                gameState.modules.filter(m => m.type === MODULE_TYPES.MAGIC).forEach(m => { m.level = Math.max(m.level, l.magic); updateModuleDisplay(m); });
            }
            updateInvestUI();
            updateCoreVisual();
            updateDisplay();
        }

        // ä¸­å¤®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã®é€²åŒ–ï¼ˆåˆè¨ˆãƒ¬ãƒ™ãƒ«ã§æ®µéšçš„ã«è±ªè¯ã«ï¼‰
        function updateCoreVisual() {
            const totalLv = gameState.investLevels.human + gameState.investLevels.machine + gameState.investLevels.magic;
            const el = elements.coreVisual;
            if (!el) return;
            if (totalLv < 3) {
                el.textContent = 'âœ¨';
                el.style.fontSize = '48px';
            } else if (totalLv < 6) {
                el.textContent = 'ğŸŒŸ';
                el.style.fontSize = '64px';
            } else if (totalLv < 9) {
                el.textContent = 'ğŸ’«';
                el.style.fontSize = '80px';
            } else {
                el.textContent = 'ğŸ›¡ï¸âš¡';
                el.style.fontSize = '88px';
            }
        }

        // ã‚²ãƒ¼ãƒ å†é–‹
        function restartGame() {
            gameState = {
                mana: 1000,
                tech: 500,
                materials: 300,
                personnel: 0,
                completion: 0,
                modules: [],
                nextModuleId: 1,
                gameRunning: true,
                autoMode: false,
                storyIndex: 0,
                startedAt: Date.now(),
                secondsElapsed: 0,
                choices: { summon: 0, enhance: 0, machine: 0, magic: 0, invest: 0 },
                clickGainBase: 1,
                investLevels: { human: 0, machine: 0, magic: 0 }
            };
            
            elements.field.innerHTML = '';
            // å†ç”Ÿæˆ
            const core = document.createElement('div');
            core.className = 'core-visual';
            core.id = 'core-visual';
            core.textContent = 'âœ¨';
            elements.field.appendChild(core);
            elements.coreVisual = core;

            const clicker = document.createElement('div');
            clicker.className = 'clicker';
            clicker.id = 'clicker';
            clicker.innerHTML = 'ã‚¯ãƒªãƒƒã‚¯ã§é­”åŠ›+<span id="click-gain">1</span>';
            elements.field.appendChild(clicker);
            elements.clicker = clicker;
            elements.clickGain = document.getElementById('click-gain');

            elements.gameOver.style.display = 'none';
            document.getElementById('auto-btn').textContent = 'è‡ªå‹•é–‹ç™º';
            document.getElementById('auto-btn').style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
            
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆå†ãƒã‚¤ãƒ³ãƒ‰
            elements.clicker.addEventListener('click', () => {
                const gain = getClickGain();
                gameState.mana += gain;
                elements.clickGain.textContent = gain;
                showEffect(elements.field.offsetWidth/2, elements.field.offsetHeight/2, `+${gain}é­”åŠ›`);
                updateDisplay();
            });

            updateInvestUI();
            updateCoreVisual();
                checkTimeLimit();
            updateDisplay();
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        init();
    </script>
</body>
</html>