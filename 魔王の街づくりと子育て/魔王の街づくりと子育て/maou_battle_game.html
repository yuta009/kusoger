<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”ç‹ã®è¡—ã¥ãã‚Šã¨å­è‚²ã¦ â€” å°‘å¹´æ±ºæˆ¦éŒ²</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Gothic', 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0015 0%, #1a0033 50%, #2d004d 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #ff00ff;
            font-size: 2em;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #ff00ff; }
            to { text-shadow: 0 0 30px #ff00ff, 0 0 50px #8b00ff; }
        }

        .screen {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        .title-screen {
            text-align: center;
            padding: 80px 20px;
        }

        .title-logo {
            font-size: 2.5em;
            margin-bottom: 40px;
            line-height: 1.5;
        }

        .title-story {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8b00ff;
            border-radius: 10px;
            line-height: 1.8;
            color: #ccc;
        }

        /* æ‹ ç‚¹ç”»é¢ */
        .base-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .panel {
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #8b00ff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(139, 0, 255, 0.4);
        }

        .panel h2 {
            color: #ffaa00;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #8b00ff;
            padding-bottom: 10px;
        }

        .stat-list {
            display: grid;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid #8b00ff;
        }

        .stat-label {
            color: #ffaa00;
            font-weight: bold;
        }

        .stat-value {
            color: #fff;
            font-size: 1.2em;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 25px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #6600cc, #9900ff);
            border: 3px solid #ff00ff;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn:hover {
            background: linear-gradient(135deg, #9900ff, #cc00ff);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 0, 255, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            grid-column: span 2;
            font-size: 1.3em;
            background: linear-gradient(135deg, #ff0066, #ff3399);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #ff3399, #ff66cc);
        }

        /* ãƒãƒˆãƒ«ç”»é¢ */
        .battle-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .turn-display {
            text-align: center;
            font-size: 2em;
            margin: 20px 0;
            color: #ffaa00;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .fighters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .fighter {
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #8b00ff;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .fighter-icon {
            font-size: 5em;
            margin: 20px 0;
        }
        
        .fighter-icon img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border: 2px solid #8b00ff;
        }

        .fighter-name {
            font-size: 1.5em;
            color: #ffaa00;
            margin-bottom: 15px;
        }

        .hp-bar-container {
            margin: 20px 0;
        }

        .hp-bar {
            width: 100%;
            height: 40px;
            background: #330000;
            border: 3px solid #ff0000;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .stat-badge {
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #8b00ff;
        }

        .stat-badge-label {
            color: #00ffff;
            font-size: 0.9em;
        }

        .stat-badge-value {
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* æˆ¦é—˜ãƒ­ã‚° */
        .battle-log {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-left: 4px solid #00ff00;
            padding-left: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-damage { border-left-color: #ff0000; color: #ff6666; }
        .log-heal { border-left-color: #00ff00; color: #66ff66; }
        .log-buff { border-left-color: #ffaa00; color: #ffcc66; }
        .log-system { border-left-color: #00ffff; color: #66ffff; }

        /* æ‰‹æœ­ */
        .hand-area {
            margin: 30px 0;
        }

        .hand-title {
            text-align: center;
            color: #ffaa00;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .hand-cards {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .card {
            width: 150px;
            background: linear-gradient(135deg, #1a0033, #330066);
            border: 3px solid #8b00ff;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .card:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: #ff00ff;
            box-shadow: 0 15px 40px rgba(255, 0, 255, 0.7);
        }

        .card.used {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .card.used:hover {
            transform: none;
        }

        .card-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffaa00;
            margin-bottom: 8px;
        }

        .card-type {
            font-size: 0.85em;
            color: #00ffff;
            margin-bottom: 10px;
        }

        .card-power {
            font-size: 2em;
            font-weight: bold;
            color: #ff6600;
            text-align: center;
            margin: 10px 0;
            text-shadow: 0 0 10px #ff6600;
        }

        .card-desc {
            font-size: 0.85em;
            color: #ccc;
            line-height: 1.4;
        }
        
        .card-icon {
            width: 32px;
            height: 32px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }

        /* ãƒ‡ãƒƒã‚­ç·¨é›† */
        .deck-editor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .card-pool, .current-deck {
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #8b00ff;
            border-radius: 15px;
            padding: 25px;
        }

        .card-pool h3, .current-deck h3 {
            color: #ffaa00;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .card-list {
            max-height: 450px;
            overflow-y: auto;
        }

        .card-list-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #666;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .card-list-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #8b00ff;
        }

        .card-list-name {
            font-weight: bold;
            color: #ffaa00;
            margin-bottom: 5px;
        }

        .card-list-desc {
            font-size: 0.9em;
            color: #ccc;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a0033, #330066);
            border: 4px solid #ff00ff;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #ffaa00;
        }

        .modal-text {
            font-size: 1.2em;
            margin: 20px 0;
            line-height: 1.6;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #6600cc, #9900ff);
            border-radius: 5px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .base-layout,
            .fighters,
            .deck-editor {
                grid-template-columns: 1fr;
            }

            .card {
                width: 100%;
                max-width: 200px;
            }
        }
        /* BGM */
        #bgm {
            display: none;
        }
        
        /* BGMç®¡ç†ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰ */
    </style>
</head>
<body>
    <!-- BGM -->
    <audio id="bgm" loop>
        <source src="music/é‹å‘½ã®ã‚«ãƒ¼ãƒ‰.mp3" type="audio/mpeg">
    </audio>
    
    <div class="container">
        <h1>âš”ï¸ é­”ç‹ã®è¡—ã¥ãã‚Šã¨å­è‚²ã¦ â€” å°‘å¹´æ±ºæˆ¦éŒ² âš”ï¸</h1>

        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="titleScreen" class="screen active">
            <div class="title-screen">
                <div class="title-logo">
                    ğŸ‘¹ é­”ç‹ã®è¡—ã¥ãã‚Šã¨å­è‚²ã¦<br>
                    â€” å°‘å¹´æ±ºæˆ¦éŒ² â€”
                </div>
                <div class="title-story">
                    ç•°ä¸–ç•Œè»¢ç”Ÿã‚’é˜»æ­¢ã—ãŸé­”ç‹ã¯ã€è»äº‹åŠ›æ‹¡å¤§ã®ãŸã‚ã€é­”ç‹ã®è¡—ã¥ãã‚Šã‚’å†é–‹ã—ãŸã€‚ãã‚“ãªæ™‚ã€ã‚ã‚‹ä¸€äººã®äººé–“ã®å°‘å¹´ã‚’æ‹¾ã†ã€‚<br><br>
                    å‹‡è€…ã¯ã¾ãŸç”Ÿã¾ã‚Œã¦ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ãã®å¯¾æŠ—ç­–ã¨ã—ã¦é­”ç‹ã¯è¡—ã¥ãã‚Šã®å‚ã‚‰å­è‚²ã¦ã‚’é–‹å§‹ã—ãŸã€‚<br><br>
                    ãã®å­ä¾›ã®ç‚ºã«é­”åŠ›ã‚’çµæ™¶åŒ–ã—ã‚«ãƒ¼ãƒ‰ã«å¤‰ãˆã€æœ¬æ¥ã§ã¯å‹ã¦ãªã„æ•µã¨ãƒãƒˆãƒ«ã—å‹ã¤ã“ã¨ã«ã‚ˆã£ã¦ã€å¼·åˆ¶çš„ã«å¼·ãã—ã¦ã„ãã®ã§ã‚ã£ãŸã€‚
                </div>
                <button class="btn btn-primary" onclick="startGame()">ã¯ã˜ã‚ã‚‹</button>
            </div>
        </div>

        <!-- æ‹ ç‚¹ç”»é¢ -->
        <div id="baseScreen" class="screen">
            <div class="base-layout">
                <!-- å·¦ãƒ‘ãƒãƒ«ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div class="panel">
                    <h2>ğŸ§’ å°‘å¹´ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
                    <div class="stat-list">
                        <div class="stat-item">
                            <span class="stat-label">åå‰</span>
                            <span class="stat-value" id="boyName">ãƒ¬ã‚ªãƒ³</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ãƒ¬ãƒ™ãƒ«</span>
                            <span class="stat-value" id="boyLv">1</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">çµŒé¨“å€¤</span>
                            <span class="stat-value" id="boyExp">0 / 50</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">HP</span>
                            <span class="stat-value" id="boyHP">100 / 100</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ATK</span>
                            <span class="stat-value" id="boyATK">10</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">DEF</span>
                            <span class="stat-value" id="boyDEF">2</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">STRï¼ˆç‰©ç†è£œæ­£ï¼‰</span>
                            <span class="stat-value" id="boySTR">5</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">INTï¼ˆé­”æ³•è£œæ­£ï¼‰</span>
                            <span class="stat-value" id="boyINT">3</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Score</span>
                            <span class="stat-value" id="scoreValue">0</span>
                        </div>
                    </div>
                </div>

                <!-- å³ãƒ‘ãƒãƒ«ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="panel">
                    <h2>ğŸ° æ‹ ç‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                    <div class="stat-list">
                        <div class="stat-item">
                            <span class="stat-label">å‹åˆ©æ•°</span>
                            <span class="stat-value" id="winCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ãƒ‡ãƒƒã‚­æšæ•°</span>
                            <span class="stat-value" id="deckCount">10</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æ‰€æŒã‚«ãƒ¼ãƒ‰</span>
                            <span class="stat-value" id="collectionCount">10</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn" onclick="startTraining()">ğŸ’ª è¨“ç·´</button>
                        <button class="btn" onclick="showTraningMenu()">âš”ï¸ é›éŒ¬</button>
                        <button class="btn" onclick="showDeckEditor()">ğŸ“‹ ãƒ‡ãƒƒã‚­ç·¨é›†</button>
                        <button class="btn btn-primary" onclick="startBattle()">âš”ï¸ å‡ºæ’ƒ</button>
                        <button class="btn" onclick="recoverWithScore()">ğŸ’Š å›å¾©ï¼ˆScore-200, HP+20ï¼‰</button>
                        <button class="btn" onclick="showHowToPlay()">ğŸ“– éŠã³æ–¹</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒãƒˆãƒ«ç”»é¢ -->
        <div id="battleScreen" class="screen">
            <div class="battle-container">
                <div class="turn-display" id="turnDisplay">ã‚¿ãƒ¼ãƒ³ 1 / 10</div>

                <div class="fighters">
                    <!-- å°‘å¹´ -->
                    <div class="fighter">
                        <div class="fighter-icon" id="boyIcon"><img src="picture/8_Young Boy (Leon).png" alt="ãƒ¬ã‚ªãƒ³"></div>
                        <div class="fighter-name" id="battleBoyName">ãƒ¬ã‚ªãƒ³</div>
                        <div class="hp-bar-container">
                            <div class="hp-bar">
                                <div class="hp-fill" id="boyHPBar" style="width: 100%">
                                    <span id="boyHPText">100 / 100</span>
                                </div>
                            </div>
                        </div>
                        <div class="stats-row">
                            <div class="stat-badge">
                                <div class="stat-badge-label">ATK</div>
                                <div class="stat-badge-value" id="battleBoyATK">10</div>
                            </div>
                            <div class="stat-badge">
                                <div class="stat-badge-label">DEF</div>
                                <div class="stat-badge-value" id="battleBoyDEF">2</div>
                            </div>
                            <div class="stat-badge">
                                <div class="stat-badge-label">STR</div>
                                <div class="stat-badge-value" id="battleBoySTR">5</div>
                            </div>
                        </div>
                    </div>

                    <!-- æ•µ -->
                    <div class="fighter">
                        <div class="fighter-icon" id="enemyIcon"><img src="" alt="æ•µ" id="enemyIconImg"></div>
                        <div class="fighter-name" id="enemyName">æ–°äººå†’é™ºè€…</div>
                        <div class="hp-bar-container">
                            <div class="hp-bar">
                                <div class="hp-fill" id="enemyHPBar" style="width: 100%">
                                    <span id="enemyHPText">60 / 60</span>
                                </div>
                            </div>
                        </div>
                        <div class="stats-row">
                            <div class="stat-badge">
                                <div class="stat-badge-label">ATK</div>
                                <div class="stat-badge-value" id="enemyATK">8</div>
                            </div>
                            <div class="stat-badge">
                                <div class="stat-badge-label">DEF</div>
                                <div class="stat-badge-value" id="enemyDEF">1</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="battle-log" id="battleLog"></div>

                <div class="hand-area">
                    <div class="hand-title">ğŸ´ æ‰‹æœ­ï¼ˆã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½¿ç”¨ï¼‰</div>
                    <div class="hand-cards" id="handCards"></div>
                </div>

            </div>
        </div>

        <!-- ãƒ‡ãƒƒã‚­ç·¨é›†ç”»é¢ -->
        <div id="deckScreen" class="screen">
            <div class="panel" style="margin-bottom: 20px;">
                <h2 style="text-align: center;">ğŸ“‹ ãƒ‡ãƒƒã‚­ç·¨é›†</h2>
            </div>
            <div class="deck-editor">
                <div class="card-pool">
                    <h3>ğŸ’ æ‰€æŒã‚«ãƒ¼ãƒ‰ä¸€è¦§</h3>
                    <div class="card-list" id="cardPool"></div>
                </div>
                <div class="current-deck">
                    <h3>ğŸ“‹ ç¾åœ¨ã®ãƒ‡ãƒƒã‚­ï¼ˆ<span id="deckSize">10</span>/10ï¼‰</h3>
                    <div class="card-list" id="deckList"></div>
                </div>
            </div>
            <div class="button-group" style="margin-top: 30px;">
                <button class="btn" onclick="closeDeckEditor()">å®Œäº†</button>
            </div>
        </div>

        <!-- ãƒªã‚¶ãƒ«ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="resultModal" class="modal">
            <div class="modal-content">
                <div class="modal-title" id="resultTitle">ğŸ‰ å‹åˆ©ï¼ ğŸ‰</div>
                <div class="modal-text" id="resultText"></div>
                <button class="btn" onclick="closeResult()">æ¬¡ã¸</button>
            </div>
        </div>

        <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒœã‚¹å‡ºç¾æ™‚ãªã©ï¼‰ -->
        <div id="storyModal" class="modal">
            <div class="modal-content">
                <div class="modal-title" id="storyTitle">å‹‡è€…ã‚¢ãƒ«ãƒˆã€ç¾ã‚‹</div>
                <div class="modal-text" id="storyText"></div>
                <button class="btn" onclick="closeModal('storyModal')">æˆ¦ã†</button>
            </div>
        </div>

        <!-- éŠã³æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="howtoModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">ğŸ“– éŠã³æ–¹</div>
                <div class="modal-text" style="text-align: left;">
                    ãƒ»ç›®çš„ï¼šå°‘å¹´ã‚’ã‚«ãƒ¼ãƒ‰ã§æ”¯æ´ã—ã€CPUã«å‹åˆ©ã—ã¦æˆé•·ã•ã›ã‚‹ã€‚<br>
                    ãƒ»æ“ä½œï¼šã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§ä½¿ç”¨ï¼ˆæ¯ã‚¿ãƒ¼ãƒ³1æšï¼‰ã€‚<br>
                    ãƒ»å‹åˆ©æ¡ä»¶ï¼šæ•µHPã‚’0ã€ã¾ãŸã¯10ã‚¿ãƒ¼ãƒ³å¾Œã«è‡ªåˆ†ã®HPãŒä¸Šå›ã‚‹ã€‚<br>
                    ãƒ»è¨“ç·´ï¼šEXPã®ã¿ç²å¾—ï¼ˆScore-5æ¶ˆè²»ï¼‰ã€‚<br>
                    ãƒ»é›éŒ¬ï¼šSTR/INTã‚’+1ï¼ˆEXP-2 & Score-3æ¶ˆè²»ï¼‰ã€‚<br>
                    ãƒ»å‡ºæ’ƒï¼šå‹åˆ©ã§æœªæ‰€æŒã‚«ãƒ¼ãƒ‰ã‚’æœ€å¤§5ç¨®ç²å¾—ï¼ˆæ•µã®åˆå›æ’ƒç ´ã®ã¿ï¼‰ã€‚<br>
                    ãƒ»ã‚¹ã‚³ã‚¢ï¼šå‹åˆ©ã§åŠ ç‚¹ã€‚å¼±ã„ã‚«ãƒ¼ãƒ‰ä¸­å¿ƒã§å‹ã¤ã»ã©é«˜å¾—ç‚¹ã€‚<br>
                    ãƒ»å›å¾©ï¼šScore-200ã§HP+20ï¼ˆæ‹ ç‚¹ã‹ã‚‰å®Ÿè¡Œï¼‰ã€‚
                </div>
                <button class="btn" onclick="closeModal('howtoModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <!-- é›éŒ¬ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="trainingModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">âš”ï¸ é›éŒ¬</div>
                <div class="modal-text">
                    EXP -2 æ¶ˆè²»ã§æˆé•·<br>
                    ç¾åœ¨ã®EXP: <span id="trainingExp">0</span><br>
                    ç¾åœ¨ã®STR: <span id="trainingSTR">5</span><br>
                    ç¾åœ¨ã®INT: <span id="trainingINT">3</span>
                </div>
                <div class="button-group">
                    <button class="btn" onclick="confirmTraining('str')">STR+1</button>
                    <button class="btn" onclick="confirmTraining('int')">INT+1</button>
                    <button class="btn" onclick="closeModal('trainingModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
        let gameData = {
            boy: {
                name: 'ãƒ¬ã‚ªãƒ³',
                lv: 1,
                exp: 0,
                expToNext: 50,
                hp: 100,
                hpMax: 100,
                atk: 10,
                def: 2,
                str: 5,
                int: 3
            },
            deck: [],
            collection: [],
            wins: 0,
            defeatedEnemies: [],
            score: 0
        };

        // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        const cardDB = [
            { id: 'c01', name: 'é—‡å‰£', type: 'attack', attribute: 'physical', power: 8, desc: '8ãƒ€ãƒ¡ãƒ¼ã‚¸' },
            { id: 'c02', name: 'ç«çƒ', type: 'attack', attribute: 'magic', power: 10, desc: '10é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸' },
            { id: 'c03', name: 'éœ§ã®ç›¾', type: 'defend', attribute: '', power: 6, desc: 'è¢«ãƒ€ãƒ¡è»½æ¸›6' },
            { id: 'c04', name: 'è¿…é€Ÿå›å¾©', type: 'heal', attribute: '', power: 12, desc: 'HP12å›å¾©' },
            { id: 'c05', name: 'æ¿€åŠ±', type: 'buff', attribute: '', power: 2, desc: 'ATK+2' },
            { id: 'c06', name: 'é‡æ–¬', type: 'attack', attribute: 'physical', power: 14, desc: '14ãƒ€ãƒ¡ãƒ¼ã‚¸' },
            { id: 'c07', name: 'ç¡¬åŒ–', type: 'buff', attribute: '', power: 3, desc: 'DEF+3' },
            { id: 'c08', name: 'å¸è¡€', type: 'special', attribute: 'physical', power: 6, desc: '6ãƒ€ãƒ¡+å›å¾©3' },
            { id: 'c09', name: 'å·ä»¤', type: 'special', attribute: '', power: 0, desc: 'æ¬¡æ”»æ’ƒ+50%' },
            { id: 'c10', name: 'å›é¿æ©Ÿæ§‹', type: 'defend', attribute: '', power: 0, desc: 'æ”»æ’ƒã‚’1å›ç„¡åŠ¹åŒ–' },
            { id: 'c11', name: 'é€£æ’ƒ', type: 'attack', attribute: 'physical', power: 12, desc: '12ãƒ€ãƒ¡ãƒ¼ã‚¸Ã—2å›' },
            { id: 'c12', name: 'æ°·æ§', type: 'attack', attribute: 'magic', power: 9, desc: '9ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆDEFç„¡è¦–20%ï¼‰' },
            { id: 'c13', name: 'å®Œå…¨é˜²å¾¡', type: 'defend', attribute: '', power: 10, desc: 'è¢«ãƒ€ãƒ¡è»½æ¸›10' },
            { id: 'c14', name: 'å¤§å›å¾©', type: 'heal', attribute: '', power: 20, desc: 'HP20å›å¾©' },
            { id: 'c15', name: 'é­”åŠ›é›†ä¸­', type: 'buff', attribute: '', power: 3, desc: 'INT+3ï¼ˆå›å¾©å¼·åŒ–ï¼‰' },
            { id: 'c16', name: 'ãƒãƒ¼ã‚µãƒ¼ã‚¯', type: 'buff', attribute: '', power: 5, desc: 'ATK+5ã€DEF-2' },
            { id: 'c17', name: 'åå°„', type: 'special', attribute: '', power: 0, desc: 'å—ã‘ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’30%è¿”ã™' },
            { id: 'c18', name: 'æ¯’åˆƒ', type: 'special', attribute: 'physical', power: 8, desc: '8ãƒ€ãƒ¡ï¼‹æ¯ã‚¿ãƒ¼ãƒ³3ãƒ€ãƒ¡ï¼ˆ3ã‚¿ãƒ¼ãƒ³ï¼‰' },
            { id: 'c19', name: 'ç¬æ®º', type: 'attack', attribute: 'physical', power: 18, desc: '18ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆHP50%ä»¥ä¸‹ã§+5ï¼‰' },
            { id: 'c20', name: 'å†ç”Ÿã®ç¥ç¦', type: 'heal', attribute: '', power: 15, desc: 'HP15å›å¾©ï¼‹æ¬¡ã®ã‚¿ãƒ¼ãƒ³5å›å¾©' },
            // ã“ã“ã‹ã‚‰æ–°è¦ã‚«ãƒ¼ãƒ‰ï¼ˆC21ã€œC30ï¼‰ï¼šæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã§æ‰±ãˆã‚‹åŠ¹æœã®ã¿
            { id: 'c21', name: 'é›·æ’ƒ', type: 'attack', attribute: 'magic', power: 13, desc: '13é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸' },
            { id: 'c22', name: 'å¼·æ–¬', type: 'attack', attribute: 'physical', power: 18, desc: '18ãƒ€ãƒ¡ãƒ¼ã‚¸' },
            { id: 'c23', name: 'é‰„å£', type: 'defend', attribute: '', power: 12, desc: 'è¢«ãƒ€ãƒ¡è»½æ¸›12' },
            { id: 'c24', name: 'æ²»ç™’', type: 'heal', attribute: '', power: 22, desc: 'HP22å›å¾©' },
            { id: 'c25', name: 'è¡æ³¢', type: 'attack', attribute: 'magic', power: 15, desc: '15é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸' },
            { id: 'c26', name: 'å‰›æ‰“', type: 'attack', attribute: 'physical', power: 19, desc: '19ãƒ€ãƒ¡ãƒ¼ã‚¸' },
            { id: 'c27', name: 'å …å®ˆ', type: 'defend', attribute: '', power: 13, desc: 'è¢«ãƒ€ãƒ¡è»½æ¸›13' },
            { id: 'c28', name: 'ç™’å…‰', type: 'heal', attribute: '', power: 24, desc: 'HP24å›å¾©' },
            { id: 'c29', name: 'çƒˆç«', type: 'attack', attribute: 'magic', power: 17, desc: '17é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸' },
            { id: 'c30', name: 'æ–­ç½ª', type: 'attack', attribute: 'physical', power: 20, desc: '20ãƒ€ãƒ¡ãƒ¼ã‚¸' }
        ];

        // æ•µãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆé€šå¸¸ãƒãƒˆãƒ«ï¼‰
        const enemyDB = [
            { name: 'æ–°äººå†’é™ºè€…', hp: 60, atk: 8, def: 1, exp: 25 },
            { name: 'é­”å°å£«ã‚»ãƒ©', hp: 80, atk: 10, def: 2, exp: 30 },
            { name: 'éŠ€é¨å£«éšŠé•·', hp: 100, atk: 12, def: 3, exp: 35 },
            { name: 'ç‹‚æˆ¦å£«ãƒãƒ«ã‚¬', hp: 120, atk: 14, def: 3, exp: 40 },
            { name: 'å‹‡è€…ã‚¢ãƒ«ãƒˆ', hp: 150, atk: 16, def: 4, exp: 50 }
        ];
        
        // è¨“ç·´ç”¨é›‘é­šæ•µ
        const trainingEnemy = { name: 'é›‘é­šæ•µ', hp: 40, atk: 5, def: 1, exp: 15 };

        // ãƒãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿
        let battle = {
            turn: 1,
            maxTurns: 10,
            hand: [],
            boy: {},
            enemy: {},
            nextBonus: 0,
            hasEvasion: false,
            isTraining: false,  // è¨“ç·´ãƒãƒˆãƒ«ã‹ã©ã†ã‹
            usedAttackPowers: [] // ä½¿ç”¨ã—ãŸæ”»æ’ƒ/é­”æ³•ã‚«ãƒ¼ãƒ‰ã®powerã‚’è¨˜éŒ²
        };

        // BGMç®¡ç†
        function playBGM(filename) {
            const bgm = document.getElementById('bgm');
            if (!bgm) return;
            
            // ç¾åœ¨ã®BGMã‚’åœæ­¢
            bgm.pause();
            bgm.currentTime = 0;
            
            // æ–°ã—ã„BGMã‚’è¨­å®š
            bgm.src = `music/${filename}`;
            bgm.volume = 0.5;  // éŸ³é‡50%
            bgm.loop = true;
            
            // BGMå†ç”Ÿ
            bgm.play().catch(e => {
                console.log('BGMå†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰:', e);
            });
        }
        
        // ãƒ¡ã‚¤ãƒ³BGMå†ç”Ÿï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æ‹ ç‚¹ï¼‰
        function playMainBGM() {
            playBGM('é‹å‘½ã®ã‚«ãƒ¼ãƒ‰.mp3');
        }
        
        // ãƒãƒˆãƒ«BGMå†ç”Ÿï¼ˆæ•µã«å¿œã˜ã¦ï¼‰
        function playBattleBGM(enemyName) {
            let bgmFile = 'é‹å‘½ã®ã‚«ãƒ¼ãƒ‰.mp3';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            
            if (enemyName === 'æ–°äººå†’é™ºè€…') {
                bgmFile = 'æ–°äººå†’é™ºè€….mp3';
            } else if (enemyName === 'é­”å°å£«ã‚»ãƒ©' || enemyName === 'éŠ€é¨å£«éšŠé•·') {
                bgmFile = 'é­”å°å£«ã‚»ãƒ©ã¨éŠ€é¨å£«éšŠé•·.mp3';
            } else if (enemyName === 'ç‹‚æˆ¦å£«ãƒãƒ«ã‚¬') {
                bgmFile = 'ç‹‚æˆ¦å£«ãƒãƒ«ã‚¬.mp3';
            } else if (enemyName === 'å‹‡è€…ã‚¢ãƒ«ãƒˆ') {
                bgmFile = 'å‹‡è€…ã‚¢ãƒ«ãƒˆï¼ˆç« ãƒœã‚¹ï¼‰.mp3';
            } else if (enemyName === 'é›‘é­šæ•µ') {
                // è¨“ç·´ãƒãƒˆãƒ«ã¯ãƒ¡ã‚¤ãƒ³BGMã®ã¾ã¾ã€ã¾ãŸã¯åˆ¥ã®BGM
                bgmFile = 'é‹å‘½ã®ã‚«ãƒ¼ãƒ‰.mp3';
            }
            
            playBGM(bgmFile);
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            // åˆæœŸåŒ–ï¼ˆã‚»ãƒ¼ãƒ–æ©Ÿèƒ½ãªã—ï¼‰
            // åˆæœŸæ‰€æŒã¯C01ã€œC10ã®ã¿
            gameData.collection = cardDB.slice(0, 10).map(c => c.id);
            gameData.deck = cardDB.slice(0, 10).map(c => c.id);  // æœ€åˆã®10æšã‚’ãƒ‡ãƒƒã‚­ã«
            showScreen('baseScreen');
            updateBaseUI();
            
            // ãƒ¡ã‚¤ãƒ³BGMå†ç”Ÿ
            playMainBGM();
        }

        // æ‹ ç‚¹UIæ›´æ–°
        function updateBaseUI() {
            const b = gameData.boy;
            document.getElementById('boyName').textContent = b.name;
            document.getElementById('boyLv').textContent = b.lv;
            document.getElementById('boyExp').textContent = `${b.exp} / ${b.expToNext}`;
            document.getElementById('boyHP').textContent = `${b.hp} / ${b.hpMax}`;
            document.getElementById('boyATK').textContent = b.atk;
            document.getElementById('boyDEF').textContent = b.def;
            document.getElementById('boySTR').textContent = b.str;
            document.getElementById('boyINT').textContent = b.int;
            document.getElementById('winCount').textContent = gameData.wins;
            document.getElementById('deckCount').textContent = gameData.deck.length;
            document.getElementById('collectionCount').textContent = gameData.collection.length;
            const scoreEl = document.getElementById('scoreValue');
            if (scoreEl) scoreEl.textContent = gameData.score;
        }

        // ãƒãƒˆãƒ«é–‹å§‹ï¼ˆé€šå¸¸ãƒãƒˆãƒ«ï¼‰
        function startBattle() {
            const enemyIdx = Math.min(Math.floor(gameData.wins / 2), enemyDB.length - 1);
            const enemy = enemyDB[enemyIdx];

            battle = {
                turn: 1,
                maxTurns: 10,
                hand: [],
                boy: {
                    hp: gameData.boy.hp,
                    hpMax: gameData.boy.hpMax,
                    atk: gameData.boy.atk,
                    def: gameData.boy.def,
                    str: gameData.boy.str,
                    int: gameData.boy.int,
                    baseAtk: gameData.boy.atk,
                    baseDef: gameData.boy.def
                },
                enemy: {
                    name: enemy.name,
                    hp: enemy.hp,
                    hpMax: enemy.hp,
                    atk: enemy.atk,
                    def: enemy.def,
                    baseAtk: enemy.atk,
                    baseDef: enemy.def,
                    exp: enemy.exp
                },
                nextBonus: 0,
                hasEvasion: false,
                isTraining: false,
                usedAttackPowers: []
            };

            // ãƒãƒˆãƒ«BGMå†ç”Ÿ
            playBattleBGM(enemy.name);

            drawHand();
            updateBattleUI();
            showScreen('battleScreen');
            addLog('âš”ï¸ ãƒãƒˆãƒ«é–‹å§‹ï¼', 'system');

            // å‹‡è€…ã‚¢ãƒ«ãƒˆå‡ºç¾ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¡¨ç¤º
            if (enemy.name === 'å‹‡è€…ã‚¢ãƒ«ãƒˆ') {
                showBossIntro();
            }
        }
        
        // è¨“ç·´ãƒãƒˆãƒ«é–‹å§‹
        function startTraining() {
            // ã‚¹ã‚³ã‚¢æ¶ˆè²»ãƒã‚§ãƒƒã‚¯ï¼ˆ-5ï¼‰
            if (gameData.score < 5) {
                alert('ã‚¹ã‚³ã‚¢ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦: 5ï¼‰');
                return;
            }
            gameData.score = Math.max(0, gameData.score - 5);
            updateBaseUI();
            battle = {
                turn: 1,
                maxTurns: 10,
                hand: [],
                boy: {
                    hp: gameData.boy.hp,  // HPã¯å¼•ãç¶™ãŒãªã„
                    hpMax: gameData.boy.hpMax,
                    atk: gameData.boy.atk,
                    def: gameData.boy.def,
                    str: gameData.boy.str,
                    int: gameData.boy.int,
                    baseAtk: gameData.boy.atk,
                    baseDef: gameData.boy.def
                },
                enemy: {
                    name: trainingEnemy.name,
                    hp: trainingEnemy.hp,
                    hpMax: trainingEnemy.hp,
                    atk: trainingEnemy.atk,
                    def: trainingEnemy.def,
                    baseAtk: trainingEnemy.atk,
                    baseDef: trainingEnemy.def,
                    exp: trainingEnemy.exp
                },
                nextBonus: 0,
                hasEvasion: false,
                isTraining: true,
                usedAttackPowers: []
            };

            // è¨“ç·´ãƒãƒˆãƒ«BGMå†ç”Ÿï¼ˆãƒ¡ã‚¤ãƒ³BGMã®ã¾ã¾ï¼‰
            playBattleBGM(trainingEnemy.name);

            drawHand();
            updateBattleUI();
            showScreen('battleScreen');
            addLog('âš”ï¸ è¨“ç·´ãƒãƒˆãƒ«é–‹å§‹ï¼', 'system');
        }

        // æ‰‹æœ­ãƒ‰ãƒ­ãƒ¼
        function drawHand() {
            const shuffled = [...gameData.deck].sort(() => Math.random() - 0.5);
            battle.hand = shuffled.slice(0, 5).map(id => {
                const card = cardDB.find(c => c.id === id);
                return { ...card, used: false };
            });
        }

        // æ•µã®ç”»åƒãƒ‘ã‚¹ã‚’å–å¾—
        function getEnemyImagePath(enemyName) {
            const imageMap = {
                'æ–°äººå†’é™ºè€…': 'picture/1_Rookie Adventurer.png',
                'é­”å°å£«ã‚»ãƒ©': 'picture/2_Sera the Mage.png',
                'éŠ€é¨å£«éšŠé•·': 'picture/3_Silver Knight Captain.png',
                'ç‹‚æˆ¦å£«ãƒãƒ«ã‚¬': 'picture/4_Berserker Varga.png',
                'å‹‡è€…ã‚¢ãƒ«ãƒˆ': 'picture/5_Brave Alto.png',
                'é›‘é­šæ•µ': 'picture/6_Weak Enemy (Training).png'
            };
            return imageMap[enemyName] || 'picture/1_Rookie Adventurer.png';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
        
        // ãƒãƒˆãƒ«UIæ›´æ–°
        function updateBattleUI() {
            document.getElementById('turnDisplay').textContent = `ã‚¿ãƒ¼ãƒ³ ${battle.turn} / ${battle.maxTurns}`;
            document.getElementById('battleBoyName').textContent = gameData.boy.name;
            document.getElementById('enemyName').textContent = battle.enemy.name;

            // æ•µã®ç”»åƒã‚’æ›´æ–°
            const enemyIconImg = document.getElementById('enemyIconImg');
            if (enemyIconImg) {
                enemyIconImg.src = getEnemyImagePath(battle.enemy.name);
                enemyIconImg.alt = battle.enemy.name;
            }

            // HPæ›´æ–°
            const boyHPPct = Math.max(0, (battle.boy.hp / battle.boy.hpMax) * 100);
            document.getElementById('boyHPBar').style.width = boyHPPct + '%';
            document.getElementById('boyHPText').textContent = `${Math.max(0, battle.boy.hp)} / ${battle.boy.hpMax}`;

            const enemyHPPct = Math.max(0, (battle.enemy.hp / battle.enemy.hpMax) * 100);
            document.getElementById('enemyHPBar').style.width = enemyHPPct + '%';
            document.getElementById('enemyHPText').textContent = `${Math.max(0, battle.enemy.hp)} / ${battle.enemy.hpMax}`;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            document.getElementById('battleBoyATK').textContent = battle.boy.atk;
            document.getElementById('battleBoyDEF').textContent = battle.boy.def;
            document.getElementById('battleBoySTR').textContent = battle.boy.str;
            document.getElementById('enemyATK').textContent = battle.enemy.atk;
            document.getElementById('enemyDEF').textContent = battle.enemy.def;

            renderHand();
        }

        // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ‘ã‚¹ã‚’å–å¾—
        function getCardTypeIcon(cardType) {
            const iconMap = {
                'attack': 'picture/9_Attack Icon.png',
                'defend': 'picture/10_Defense Icon.png',
                'heal': 'picture/11_Recovery Icon.png',
                'special': 'picture/12_Special Icon.png',
                'buff': 'picture/12_Special Icon.png'  // è£œåŠ©ã¯ç‰¹æ®Šã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ç”¨
            };
            return iconMap[cardType] || '';
        }
        
        // æ‰‹æœ­è¡¨ç¤º
        function renderHand() {
            const handEl = document.getElementById('handCards');
            handEl.innerHTML = '';

            battle.hand.forEach((card, idx) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card' + (card.used ? ' used' : '');
                const attributeText = card.attribute === 'physical' ? 'ç‰©ç†' : (card.attribute === 'magic' ? 'é­”æ³•' : '');
                const iconPath = getCardTypeIcon(card.type);
                const iconHtml = iconPath ? `<img src="${iconPath}" alt="${card.type}" class="card-icon">` : '';
                cardEl.innerHTML = `
                    <div class="card-name">${iconHtml}${card.name}</div>
                    <div class="card-type">[${card.type}${attributeText ? 'ãƒ»' + attributeText : ''}]</div>
                    <div class="card-power">${card.power > 0 ? card.power : 'ï¼'}</div>
                    <div class="card-desc">${card.desc}</div>
                `;
                if (!card.used) {
                    cardEl.onclick = () => playCard(idx);
                }
                handEl.appendChild(cardEl);
            });
        }

        // ã‚«ãƒ¼ãƒ‰ä½¿ç”¨
        function playCard(idx) {
            const card = battle.hand[idx];
            if (card.used) return;

            card.used = true;
            addLog(`ğŸ’« ${card.name}ã‚’ä½¿ç”¨ï¼`, 'system');

            let power = card.power;

            // å·ä»¤åŠ¹æœ
            if (battle.nextBonus > 0) {
                power = Math.floor(power * (1 + battle.nextBonus));
                addLog(`âœ¨ å·ä»¤åŠ¹æœã§å¨åŠ›UPï¼`, 'buff');
                battle.nextBonus = 0;
            }

            switch (card.type) {
                case 'attack':
                    // ç‰©ç†/é­”æ³•ã§STR/INTã‚’ä½¿ã„åˆ†ã‘
                    let statBonus = 0;
                    if (card.attribute === 'physical') {
                        statBonus = battle.boy.str;
                    } else if (card.attribute === 'magic') {
                        statBonus = battle.boy.int;
                    }
                    let dmg = battle.boy.atk + power + statBonus - battle.enemy.def;
                    dmg = Math.max(1, dmg);
                    battle.enemy.hp -= dmg;
                    addLog(`âš”ï¸ æ•µã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, 'damage');
                    // æ”»æ’ƒ/é­”æ³•ã‚«ãƒ¼ãƒ‰ã®powerã‚’è¨˜éŒ²
                    if (card.attribute === 'physical' || card.attribute === 'magic') {
                        battle.usedAttackPowers.push(card.power);
                    }
                    break;

                case 'defend':
                    if (card.id === 'c10') {
                        battle.hasEvasion = true;
                        addLog(`ğŸ›¡ï¸ æ¬¡ã®æ”»æ’ƒã‚’å›é¿ï¼`, 'buff');
                    } else {
                        battle.boy.def += power;
                        addLog(`ğŸ›¡ï¸ é˜²å¾¡åŠ›ãŒ${power}ä¸Šæ˜‡ï¼`, 'buff');
                    }
                    break;

                case 'heal':
                    let heal = Math.floor(power + battle.boy.int * 0.5);
                    heal = Math.min(heal, battle.boy.hpMax - battle.boy.hp);
                    battle.boy.hp += heal;
                    addLog(`â¤ï¸ HPãŒ${heal}å›å¾©ï¼`, 'heal');
                    break;

                case 'buff':
                    if (card.id === 'c05') {
                        battle.boy.atk += power;
                        addLog(`âš¡ æ”»æ’ƒåŠ›ãŒ${power}ä¸Šæ˜‡ï¼`, 'buff');
                    } else if (card.id === 'c07') {
                        battle.boy.def += power;
                        addLog(`ğŸ›¡ï¸ é˜²å¾¡åŠ›ãŒ${power}ä¸Šæ˜‡ï¼`, 'buff');
                    }
                    break;

                case 'special':
                    if (card.id === 'c08') {
                        let dmg = power + battle.boy.str;
                        dmg = Math.max(1, dmg - battle.enemy.def);
                        battle.enemy.hp -= dmg;
                        battle.boy.hp = Math.min(battle.boy.hpMax, battle.boy.hp + 3);
                        addLog(`ğŸ©¸ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹3å›å¾©ï¼`, 'heal');
                    } else if (card.id === 'c09') {
                        battle.nextBonus = 0.5;
                        addLog(`ğŸ“£ å·ä»¤ï¼æ¬¡ã®ã‚«ãƒ¼ãƒ‰ãŒå¼·åŒ–ã•ã‚Œã‚‹ï¼`, 'buff');
                    }
                    break;
            }

            updateBattleUI();
            
            // è‡ªå‹•çš„ã«æ•µã®ã‚¿ãƒ¼ãƒ³ã«ç§»è¡Œ
            setTimeout(() => {
                checkBattleEnd();  // ã¾ãšå‹åˆ©/æ•—åŒ—åˆ¤å®š
                if (battle.boy.hp > 0 && battle.enemy.hp > 0 && battle.turn <= battle.maxTurns) {
                    enemyTurn();
                    setTimeout(() => {
                        checkBattleEnd();  // æ•µã®ã‚¿ãƒ¼ãƒ³å¾Œã®åˆ¤å®š
                        if (battle.boy.hp > 0 && battle.enemy.hp > 0) {
                            nextTurn();
                        }
                    }, 1000);
                }
            }, 500);
        }

        // æ•µã®ã‚¿ãƒ¼ãƒ³
        function enemyTurn() {
            const hpPct = battle.enemy.hp / battle.enemy.hpMax;
            let action = 'attack';

            // AIåˆ¤å®š
            if (hpPct < 0.3 && Math.random() < 0.5) {
                action = 'heal';
            } else if (hpPct > 0.7 && Math.random() < 0.2) {
                action = 'buff';
            }

            addLog(`ğŸ‘¹ ${battle.enemy.name}ã®ã‚¿ãƒ¼ãƒ³ï¼`, 'system');

            if (action === 'attack') {
                if (battle.hasEvasion) {
                    battle.hasEvasion = false;
                    addLog(`ğŸŒ€ æ”»æ’ƒã‚’å›é¿ã—ãŸï¼`, 'buff');
                } else {
                    // ãƒ€ãƒ¡ãƒ¼ã‚¸ã«å¹…ã‚’æŒãŸã›ã‚‹ï¼ˆÂ±15%ï¼‰ï¼‹ä½ç¢ºç‡ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«
                    const base = Math.max(1, battle.enemy.atk - battle.boy.def);
                    const variance = 0.85 + Math.random() * 0.3; // 0.85ã€œ1.15
                    let dmg = Math.max(1, Math.floor(base * variance));
                    let isCrit = false;
                    if (Math.random() < 0.1) { // 10%ã§ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«
                        dmg = Math.floor(dmg * 1.5);
                        isCrit = true;
                    }
                    battle.boy.hp -= dmg;
                    addLog(isCrit ? `ğŸ’¥ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼` : `âš”ï¸ ${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`, 'damage');
                }
            } else if (action === 'heal') {
                let heal = Math.floor(battle.enemy.hpMax * 0.2);
                heal = Math.min(heal, battle.enemy.hpMax - battle.enemy.hp);
                battle.enemy.hp += heal;
                addLog(`ğŸ’š æ•µãŒ${heal}HPå›å¾©ï¼`, 'heal');
            } else if (action === 'buff') {
                battle.enemy.atk += 2;
                addLog(`âš¡ æ•µã®æ”»æ’ƒåŠ›ãŒä¸Šæ˜‡ï¼`, 'buff');
            }
        }

        // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
        function nextTurn() {
            // DEFãƒªã‚»ãƒƒãƒˆ
            battle.boy.def = battle.boy.baseDef;
            battle.enemy.def = battle.enemy.baseDef;

            battle.turn++;
            
            // æ‰‹æœ­ã‚’å†ãƒ‰ãƒ­ãƒ¼ï¼ˆ1ã‚¿ãƒ¼ãƒ³ã”ã¨ã«ã‚«ãƒ¼ãƒ‰ã‚’å¤‰ãˆã‚‹ï¼‰
            drawHand();

            updateBattleUI();

            if (battle.turn <= battle.maxTurns) {
                addLog(`--- ã‚¿ãƒ¼ãƒ³ ${battle.turn} é–‹å§‹ ---`, 'system');
                // ã‚«ãƒ¼ãƒ‰ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚‹
            } else {
                checkBattleEnd();
            }
        }

        // ãƒãƒˆãƒ«çµ‚äº†åˆ¤å®š
        function checkBattleEnd() {
            if (battle.enemy.hp <= 0) {
                victory();
            } else if (battle.boy.hp <= 0) {
                defeat();
            } else if (battle.turn > battle.maxTurns) {
                if (battle.boy.hp > battle.enemy.hp) {
                    victory();
                } else {
                    defeat();
                }
            }
        }

        // å‹åˆ©
        function victory() {
            addLog('ğŸ‰ å‹åˆ©ï¼', 'heal');
            
            // ç« ãƒœã‚¹ï¼ˆå‹‡è€…ã‚¢ãƒ«ãƒˆï¼‰æ’ƒç ´æ™‚ï¼šã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºâ†’ã‚¿ã‚¤ãƒˆãƒ«ã¸
            if (battle.enemy.name === 'å‹‡è€…ã‚¢ãƒ«ãƒˆ') {
                // ãƒœã‚¹æˆ¦ã§ã‚‚ã‚¹ã‚³ã‚¢ã‚’åŠ ç®—
                const gainedScore = calculateBattleScore();
                gameData.score = Math.min(9999, gameData.score + gainedScore);
                setTimeout(() => {
                    const titleEl = document.getElementById('resultTitle');
                    const textEl = document.getElementById('resultText');
                    const btn = document.querySelector('#resultModal .btn');
                    titleEl.innerHTML = 'ğŸŠ æ±ºç€ ğŸŠ';
                    textEl.innerHTML = (
                        'å°‘å¹´ã¯å¹¾å¤šã®æˆ¦ã„ã‚’è¶Šãˆã€ã¤ã„ã«å‹‡è€…ã‚¢ãƒ«ãƒˆã‚’æ‰“ã¡å€’ã—ãŸã€‚<br>' +
                        'é­”åŠ›ã®ã‚«ãƒ¼ãƒ‰ã¯é™ã‹ã«è¼ãã‚’åã‚ã€è¡—ã‚’è¦†ã£ã¦ã„ãŸä¸ç©ã¯éœ§ã®ã‚ˆã†ã«æ¶ˆãˆã‚‹ã€‚<br>' +
                        'é­”ç‹ã¯çŸ­ãå‘Šã’ã‚‹â€”â€”ã€Œã“ã‚Œã§ã€ã—ã°ã‚‰ãã¯å‹‡è€…ã¯ç”Ÿã¾ã‚Œã¾ã„ã€ã€‚<br><br>' +
                        'å°‘å¹´ã¯è‡ªã‚‰ã®æ„å¿—ã§ç«‹ã¡ã€é¸ã¶åŠ›ã‚’å¾—ãŸã€‚é­”ç‹ã¯è¡—ã¥ãã‚Šã¸ã€å°‘å¹´ã¯æ¬¡ã®æˆé•·ã¸ã¨æ­©ã¿å‡ºã™ã€‚<br><br>' +
                        `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${gameData.score}ï¼ˆä»Šå› +${gainedScore}ï¼‰`
                    );
                    btn.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹';
                    btn.onclick = () => {
                        resetGame();
                        document.getElementById('resultModal').classList.remove('active');
                    };
                    document.getElementById('resultModal').classList.add('active');
                }, 1000);
                return;
            }

            // é€šå¸¸/è¨“ç·´ãƒãƒˆãƒ«ã®å‡¦ç†
            const expGain = battle.enemy.exp;
            gameData.boy.exp += expGain;

            let resultText = `çµŒé¨“å€¤ +${expGain}`;
            
            if (!battle.isTraining) {
                gameData.wins++;
                const enemyName = battle.enemy.name;
                // åŒä¸€æ•µã®å†æ’ƒç ´ã§ã¯ã‚«ãƒ¼ãƒ‰è¿½åŠ ã—ãªã„ï¼ˆåˆå›ã®ã¿ï¼‰
                if (!gameData.defeatedEnemies.includes(enemyName)) {
                    gameData.defeatedEnemies.push(enemyName);
                    // æ–°ã‚«ãƒ¼ãƒ‰ã‚’5ç¨®ã¾ã§è¿½åŠ ï¼ˆæœªæ‰€æŒã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
                    let availableCards = cardDB.filter(c => !gameData.collection.includes(c.id));
                    const addCount = Math.min(5, availableCards.length);
                    if (addCount > 0) {
                        availableCards = availableCards.sort(() => Math.random() - 0.5);
                        const gained = availableCards.slice(0, addCount);
                        gained.forEach(c => gameData.collection.push(c.id));
                        resultText += `<br>æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ç²å¾—: ${gained.map(c => c.name).join('ã€')}`;
                    }
                } else {
                    resultText += `<br>ã‚«ãƒ¼ãƒ‰è¿½åŠ ãªã—ï¼ˆåŒã˜æ•µã®å†æ’ƒç ´ï¼‰`;
                }
                gameData.boy.hp = battle.boy.hp;
                // ã‚¹ã‚³ã‚¢åŠ ç®—ï¼ˆé€šå¸¸å‹åˆ©ï¼‰
                const gainedScore = calculateBattleScore();
                gameData.score = Math.min(9999, gameData.score + gainedScore);
                resultText += `<br>ã‚¹ã‚³ã‚¢ +${gainedScore}`;
            }

            if (gameData.boy.exp >= gameData.boy.expToNext) {
                levelUp();
                resultText += `<br><br>ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼`;
            }

            setTimeout(() => {
                document.getElementById('resultTitle').innerHTML = 'ğŸ‰ å‹åˆ©ï¼ ğŸ‰';
                document.getElementById('resultText').innerHTML = resultText;
                document.getElementById('resultModal').classList.add('active');
            }, 1000);
        }

        // æ•—åŒ—
        function defeat() {
            addLog('ğŸ’€ æ•—åŒ—...', 'damage');

            setTimeout(() => {
                document.getElementById('resultTitle').innerHTML = 'ğŸ’€ æ•—åŒ—... ğŸ’€';
                document.getElementById('resultText').innerHTML = `å°‘å¹´ãŒæ­»ã‚“ã§ã—ã¾ã£ãŸ...<br><br>ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã€‚`;
                document.getElementById('resultModal').classList.add('active');
                
                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
                const closeBtn = document.querySelector('#resultModal .btn');
                closeBtn.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹';
                closeBtn.onclick = () => {
                    resetGame();
                    document.getElementById('resultModal').classList.remove('active');
                };
            }, 1000);
        }
        
        // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetGame() {
            gameData = {
                boy: {
                    name: 'ãƒ¬ã‚ªãƒ³',
                    lv: 1,
                    exp: 0,
                    expToNext: 50,
                    hp: 100,
                    hpMax: 100,
                    atk: 10,
                    def: 2,
                    str: 5,
                    int: 3
                },
                deck: [],
                collection: [],
                wins: 0,
                defeatedEnemies: [],
                score: 0
            };
            gameData.collection = cardDB.map(c => c.id);
            gameData.deck = cardDB.slice(0, 10).map(c => c.id);
            
            // ãƒ¡ã‚¤ãƒ³BGMã‚’åœæ­¢ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¸
            const bgm = document.getElementById('bgm');
            if (bgm) {
                bgm.pause();
                bgm.currentTime = 0;
            }
            
            showScreen('titleScreen');
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            const closeBtn = document.querySelector('#resultModal .btn');
            closeBtn.textContent = 'æ¬¡ã¸';
            closeBtn.onclick = closeResult;
        }

        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
        function levelUp() {
            gameData.boy.lv++;
            gameData.boy.exp = gameData.boy.exp - gameData.boy.expToNext;
            gameData.boy.expToNext = gameData.boy.lv * 50;  // LV Ã— 50
            gameData.boy.hpMax += 10;
            gameData.boy.atk += 2;
            gameData.boy.def += 1;
            addLog(`ğŸ“ˆ ãƒ¬ãƒ™ãƒ«${gameData.boy.lv}ã«ã‚¢ãƒƒãƒ—ï¼`, 'heal');
        }


        // æ‹ ç‚¹ã«æˆ»ã‚‹
        function returnToBase() {
            // ãƒ¡ã‚¤ãƒ³BGMã«æˆ»ã™
            playMainBGM();
            updateBaseUI();
            showScreen('baseScreen');
        }

        // ãƒªã‚¶ãƒ«ãƒˆã‚’é–‰ã˜ã‚‹
        function closeResult() {
            document.getElementById('resultModal').classList.remove('active');
            returnToBase();
        }
        
        // é›éŒ¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        function showTraningMenu() {
            document.getElementById('trainingExp').textContent = gameData.boy.exp;
            document.getElementById('trainingSTR').textContent = gameData.boy.str;
            document.getElementById('trainingINT').textContent = gameData.boy.int;
            document.getElementById('trainingModal').classList.add('active');
        }
        
        // é›éŒ¬å®Ÿè¡Œ
        function confirmTraining(type) {
            if (gameData.boy.exp < 2) {
                alert('EXPãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆå¿…è¦: 2ï¼‰');
                return;
            }
            // ã‚¹ã‚³ã‚¢æ¶ˆè²»ï¼ˆ-3ï¼‰
            if (gameData.score < 3) {
                alert('ã‚¹ã‚³ã‚¢ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆå¿…è¦: 3ï¼‰');
                return;
            }
            
            gameData.score = Math.max(0, gameData.score - 3);
            gameData.boy.exp -= 2;
            if (type === 'str') {
                gameData.boy.str += 1;
            } else if (type === 'int') {
                gameData.boy.int += 1;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãšã«æ›´æ–°ï¼ˆé€£ç¶šã§å¼·åŒ–å¯èƒ½ï¼‰
            document.getElementById('trainingExp').textContent = gameData.boy.exp;
            document.getElementById('trainingSTR').textContent = gameData.boy.str;
            document.getElementById('trainingINT').textContent = gameData.boy.int;
            updateBaseUI();
        }

        // ãƒ­ã‚°è¿½åŠ 
        function addLog(msg, type = 'normal') {
            const logEl = document.getElementById('battleLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            entry.textContent = msg;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }


        // ãƒ‡ãƒƒã‚­ç·¨é›†
        function showDeckEditor() {
            showScreen('deckScreen');
            renderDeckEditor();
        }

        function renderDeckEditor() {
            const poolEl = document.getElementById('cardPool');
            const deckEl = document.getElementById('deckList');

            poolEl.innerHTML = '';
            deckEl.innerHTML = '';

            // æ‰€æŒã‚«ãƒ¼ãƒ‰
            gameData.collection.forEach(id => {
                const card = cardDB.find(c => c.id === id);
                const inDeck = gameData.deck.includes(id);
                
                const item = document.createElement('div');
                item.className = 'card-list-item';
                item.innerHTML = `
                    <div>
                        <div class="card-list-name">${card.name} [${card.type}]</div>
                        <div class="card-list-desc">${card.desc}</div>
                    </div>
                    <button class="btn" style="padding: 8px 16px; font-size: 0.9em;" 
                            onclick="addToDeck('${id}')" ${inDeck ? 'disabled' : ''}>
                        ${inDeck ? 'ä½¿ç”¨ä¸­' : 'è¿½åŠ '}
                    </button>
                `;
                poolEl.appendChild(item);
            });

            // ãƒ‡ãƒƒã‚­
            gameData.deck.forEach((id, idx) => {
                const card = cardDB.find(c => c.id === id);
                const item = document.createElement('div');
                item.className = 'card-list-item';
                item.innerHTML = `
                    <div>
                        <div class="card-list-name">${card.name} [${card.type}]</div>
                        <div class="card-list-desc">${card.desc}</div>
                    </div>
                    <button class="btn" style="padding: 8px 16px; font-size: 0.9em;" 
                            onclick="removeFromDeck(${idx})">å‰Šé™¤</button>
                `;
                deckEl.appendChild(item);
            });

            document.getElementById('deckSize').textContent = gameData.deck.length;
        }

        function addToDeck(cardId) {
            if (gameData.deck.length >= 10) {
                alert('ãƒ‡ãƒƒã‚­ã¯10æšã¾ã§ã§ã™ã€‚å…ˆã«ä»–ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            if (gameData.deck.includes(cardId)) {
                alert('æ—¢ã«ãƒ‡ãƒƒã‚­ã«å…¥ã£ã¦ã„ã¾ã™');
                return;
            }
            gameData.deck.push(cardId);
            renderDeckEditor();
        }

        function removeFromDeck(idx) {
            if (gameData.deck.length <= 1) {
                alert('ãƒ‡ãƒƒã‚­ã¯æœ€ä½1æšå¿…è¦ã§ã™');
                return;
            }
            gameData.deck.splice(idx, 1);
            renderDeckEditor();
        }

        function closeDeckEditor() {
            // å®Œäº†æ™‚ã«10æšã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
            if (gameData.deck.length !== 10) {
                alert(`ãƒ‡ãƒƒã‚­ã¯10æšã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ç¾åœ¨: ${gameData.deck.length}æš\n\nä¸è¶³ã—ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            updateBaseUI();
            showScreen('baseScreen');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ã‚¹ã‚³ã‚¢æ¶ˆè²»ã§HPå›å¾©ï¼ˆScore-200ã§HP+20ï¼‰
        function recoverWithScore() {
            if (gameData.score < 200) {
                alert('ã‚¹ã‚³ã‚¢ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆå¿…è¦: 200ï¼‰');
                return;
            }
            if (gameData.boy.hp >= gameData.boy.hpMax) {
                alert('HPã¯ã™ã§ã«æœ€å¤§ã§ã™');
                return;
            }
            gameData.score = Math.max(0, gameData.score - 200);
            const heal = Math.min(20, gameData.boy.hpMax - gameData.boy.hp);
            gameData.boy.hp += heal;
            updateBaseUI();
            alert(`HPã‚’${heal}å›å¾©ã—ã¾ã—ãŸï¼ˆScore -200ï¼‰`);
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // å‹‡è€…ã‚¢ãƒ«ãƒˆå‡ºç¾ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¡¨ç¤º
        function showBossIntro() {
            const text = 'ã€ŒåŸé–€ãŒé–‹ãéŸ³ã€ã¨ã¨ã‚‚ã«ã€ç™½é‡‘ã®ç”²å†‘ã‚’çºã£ãŸé’å¹´ãŒå…‰ã®å‰£ã‚’æ²ã’ã¦ç¾ã‚ŒãŸã€‚<br>' +
                         'åã¯â€”â€”å‹‡è€…ã‚¢ãƒ«ãƒˆã€‚ä¸–ç•Œã®ä¿®å¾©ã‚’æ‹…ã†è€…ã€‚<br>' +
                         'å½¼ã®è¦–ç·šã¯ä¸€ç¬ã ã‘å°‘å¹´ã«æºã‚‰ãã€ã—ã‹ã—åˆƒã¯è¿·ã‚ãªã„ã€‚<br>' +
                         'é­”ç‹ã¯çŸ­ãå‘½ã˜ã€å°‘å¹´ã¯ã‚«ãƒ¼ãƒ‰ã‚’æ¡ã‚‹ã€‚<br>' +
                         'ã€Œã“ã“ã‹ã‚‰ãŒã€ãŠå‰ã®â€œé¸æŠâ€ã ã€ã€‚å…‰ã¨é—‡ã®æ±ºæˆ¦ãŒå§‹ã¾ã‚‹ã€‚';
            const textEl = document.getElementById('storyText');
            const titleEl = document.getElementById('storyTitle');
            if (titleEl) titleEl.textContent = 'å‹‡è€…ã‚¢ãƒ«ãƒˆã€ç¾ã‚‹';
            if (textEl) textEl.innerHTML = text;
            document.getElementById('storyModal').classList.add('active');
        }

        // éŠã³æ–¹ã‚’è¡¨ç¤º
        function showHowToPlay() {
            document.getElementById('howtoModal').classList.add('active');
        }

        // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆä»•æ§˜7.5ï¼‰
        function calculateBattleScore() {
            if (battle.isTraining) return 0;
            const baseMap = {
                'æ–°äººå†’é™ºè€…': 50,
                'é­”å°å£«ã‚»ãƒ©': 80,
                'éŠ€é¨å£«éšŠé•·': 110,
                'ç‹‚æˆ¦å£«ãƒãƒ«ã‚¬': 140,
                'å‹‡è€…ã‚¢ãƒ«ãƒˆ': 200
            };
            const expectMap = {
                'æ–°äººå†’é™ºè€…': 10,
                'é­”å°å£«ã‚»ãƒ©': 12,
                'éŠ€é¨å£«éšŠé•·': 14,
                'ç‹‚æˆ¦å£«ãƒãƒ«ã‚¬': 16,
                'å‹‡è€…ã‚¢ãƒ«ãƒˆ': 18
            };
            const base = baseMap[battle.enemy.name] || 50;
            const maxTurns = battle.maxTurns || 10;
            const usedTurns = Math.max(1, Math.min(maxTurns, battle.turn));
            const hpRatio = Math.max(0, Math.min(1, battle.boy.hp / battle.boy.hpMax));
            const remainHpBonus = Math.round(base * hpRatio * 0.3);
            const turnBonus = (maxTurns - usedTurns) * 5;

            // å¼±ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒŠã‚¹
            let avgUsedPower;
            if (battle.usedAttackPowers && battle.usedAttackPowers.length > 0) {
                const sum = battle.usedAttackPowers.reduce((a, b) => a + b, 0);
                avgUsedPower = sum / battle.usedAttackPowers.length;
            } else {
                const deckAtkCards = gameData.deck
                    .map(id => cardDB.find(c => c.id === id))
                    .filter(c => c && c.type === 'attack' && (c.attribute === 'physical' || c.attribute === 'magic'));
                if (deckAtkCards.length > 0) {
                    const sum = deckAtkCards.reduce((a, c) => a + (c.power || 0), 0);
                    avgUsedPower = sum / deckAtkCards.length;
                } else {
                    avgUsedPower = 12;
                }
            }
            const expect = expectMap[battle.enemy.name] || 12;
            const ratio = Math.max(1.0, Math.min(2.0, expect / Math.max(1, avgUsedPower)));
            const weakBonus = Math.round(base * (ratio - 1.0));

            return Math.max(0, base + remainHpBonus + turnBonus + weakBonus);
        }

    </script>
</body>
</html>